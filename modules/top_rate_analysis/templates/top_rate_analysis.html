<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ë“±ë½ìœ¨ìƒìœ„ë¶„ì„ - ì£¼ì‹ë¶„ì„ ì›¹ì•±</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <link rel="stylesheet" href="{{ url_for('top_rate_analysis.static', filename='css/top_rate_analysis.css') }}">
</head>
<body>
    <div class="container">
        <!-- ì¢Œì¸¡ ì‚¬ì´ë“œë°” -->
        <div class="sidebar">
            <div class="logo">ğŸ“Š ì£¼ì‹ë¶„ì„</div>
            <a href="/" class="menu-item">ğŸ  ëŒ€ì‹œë³´ë“œ</a>
            <div class="menu-item">ğŸ“ˆ ì¢…ëª©ì„¤ì •</div>
            <div class="menu-item active">ğŸ”¥ ë“±ë½ìœ¨ìƒìœ„</div>
            <div class="menu-item">ğŸ“Š ì‹ ê³ ê°€ë¶„ì„</div>
            <div class="menu-item">ğŸ’° ìˆ˜ê¸‰ë¶„ì„</div>
        </div>

        <!-- ë©”ì¸ ì»¨í…ì¸  -->
        <div class="main-content">
            <!-- í—¤ë” -->
            <div class="header">
                <h1>ğŸ”¥ ë“±ë½ìœ¨ìƒìœ„ë¶„ì„</h1>
                <p>ì‹¤ì‹œê°„ ì—…ì¢…ë³„ ìƒìœ„ ì¢…ëª© ë° AI ê¸°ë°˜ íˆ¬ì ë¶„ì„</p>
            </div>

            <!-- ì»¨íŠ¸ë¡¤ ë²„íŠ¼ -->
            <div class="controls">
                <button class="btn btn-primary" onclick="startCrawling()">ğŸ“¡ ì—…ì¢… ë°ì´í„° ìˆ˜ì§‘</button>
                <button class="btn btn-success" onclick="startAIAnalysis()" disabled id="aiBtn">ğŸ¤– AI ë¶„ì„ ì‹œì‘</button>
                <button class="btn btn-warning" onclick="startChartAnalysis()" disabled id="chartBtn">ğŸ“Š ì°¨íŠ¸ ë¶„ì„</button>
                <select class="btn update-schedule" onchange="setUpdateSchedule(this.value)">
                    <option value="manual">ìˆ˜ë™ ì—…ë°ì´íŠ¸</option>
                    <option value="1h">1ì‹œê°„ë§ˆë‹¤</option>
                    <option value="4h">4ì‹œê°„ë§ˆë‹¤</option>
                    <option value="daily">ì¼ì¼ ì—…ë°ì´íŠ¸</option>
                </select>
            </div>

            <!-- ìƒíƒœ í‘œì‹œ -->
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-value" id="totalSectors">0</div>
                    <div class="status-label">ë¶„ì„ ì—…ì¢…</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="totalNewsStocks">0</div>
                    <div class="status-label">ë‰´ìŠ¤ ìˆ˜ì§‘ ì¢…ëª©</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="totalAnalyzedStocks">0</div>
                    <div class="status-label">ì‹ ê³ ê°€ ê²€í†  ì¢…ëª©</div>
                </div>
                <div class="status-item">
                    <div class="status-value" id="newHighStocks">0</div>
                    <div class="status-label">ì‹ ê³ ê°€ ë‹¬ì„±</div>
                </div>
            </div>

            <!-- ì—…ì¢…ë³„ í˜„í™© -->
            <div class="section-card" id="sectorsSection" style="display: none;">
                <div class="section-header">ğŸ“ˆ ìƒìœ„ 5ê°œ ì—…ì¢… í˜„í™©</div>
                <div class="section-content">
                    <div class="sector-list" id="sectorList">
                        <!-- ì—…ì¢… ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>

                    <!-- ì¢…ëª© ìƒì„¸ í…Œì´ë¸” -->
                    <table class="stock-table" id="stockTable" style="display: none;">
                        <thead>
                            <tr>
                                <th>ì¢…ëª©ëª…</th>
                                <th>ì—…ì¢…</th>
                                <th>í˜„ì¬ê°€</th>
                                <th>ë“±ë½ìœ¨</th>
                                <th>ìˆ˜ê¸‰ë¶„ì„</th>
                                <th>ìˆ˜ê¸‰ë‹¨ê³„</th>
                                <th>ì¢…í•©ì ìˆ˜</th>
                                <th>ì£¼ìš”ë‰´ìŠ¤</th>
                            </tr>
                        </thead>
                        <tbody id="stockTableBody">
                            <!-- ì¢…ëª© ë°ì´í„°ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                        </tbody>
                    </table>
                </div>
            </div>

            <!-- AI ë¶„ì„ ê²°ê³¼ -->
            <div class="ai-analysis" style="display: none;" id="aiAnalysis">
                <h3>ğŸ¤– AI íˆ¬ì ë¶„ì„ ë¦¬í¬íŠ¸</h3>
                <div class="analysis-content" id="aiAnalysisContent">
                    <!-- AI ë¶„ì„ ê²°ê³¼ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ìˆ˜ê¸‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ -->
            <div class="supply-dashboard" style="display: none;" id="supplyDashboard">
                <h3 style="color: #2c3e50; margin-bottom: 20px;">ğŸ“Š ì‹¤ì‹œê°„ ìˆ˜ê¸‰ ë¶„ì„ ëŒ€ì‹œë³´ë“œ</h3>
                <div class="supply-grid" id="supplyGrid">
                    <!-- ìˆ˜ê¸‰ ë°ì´í„°ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤ -->
                </div>
            </div>

            <!-- ì°¨íŠ¸ ë¶„ì„ -->
            <div class="section-card" style="display: none;" id="chartSection">
                <div class="section-header">ğŸ“Š ê¸°ìˆ ì  ë¶„ì„ - ì‹ ê³ ê°€ ì¢…ëª©</div>
                <div class="section-content">
                    <div class="chart-grid" id="chartGrid">
                        <!-- ì°¨íŠ¸ê°€ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ì¶”ê°€ë©ë‹ˆë‹¤ -->
                    </div>
                </div>
            </div>

            <!-- ë¡œë”© ìƒíƒœ -->
            <div class="loading" id="loadingState" style="display: none;">
                <div class="spinner"></div>
                <p id="loadingMessage">ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...</p>
            </div>

            <!-- ì•Œë¦¼ ë©”ì‹œì§€ -->
            <div class="alert" id="alertMessage" style="display: none;">
                <span id="alertText"></span>
                <button onclick="hideAlert()">&times;</button>
            </div>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let statusCheckInterval;
        let currentAnalysisId = null;

        // ì´ˆê¸°í™”
        document.addEventListener('DOMContentLoaded', function() {
            checkStatus();
            startStatusMonitoring();
        });

        // ì—…ì¢… ë°ì´í„° ìˆ˜ì§‘ ì‹œì‘
        async function startCrawling() {
            try {
                showLoading('ì—…ì¢… ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                const response = await fetch('/top-rate/crawl-sectors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    currentAnalysisId = result.analysis_id;
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.message, 'error');
                    hideLoading();
                }

            } catch (error) {
                console.error('í¬ë¡¤ë§ ì‹œì‘ ì‹¤íŒ¨:', error);
                showAlert('í¬ë¡¤ë§ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                hideLoading();
            }
        }

        // AI ë¶„ì„ ì‹œì‘
        async function startAIAnalysis() {
            try {
                showLoading('AIê°€ ë‰´ìŠ¤ì™€ ì¬ë£Œë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                const response = await fetch('/top-rate/analyze-ai', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.message, 'error');
                    hideLoading();
                }

            } catch (error) {
                console.error('AI ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨:', error);
                showAlert('AI ë¶„ì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                hideLoading();
            }
        }

        // ì°¨íŠ¸ ë¶„ì„ ì‹œì‘
        async function startChartAnalysis() {
            try {
                showLoading('ì‹ ê³ ê°€ ì¢…ëª©ì„ ë¶„ì„í•˜ê³  ì°¨íŠ¸ë¥¼ ìƒì„±í•˜ê³  ìˆìŠµë‹ˆë‹¤...');

                const response = await fetch('/top-rate/generate-charts', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    showAlert(result.message, 'success');
                } else {
                    showAlert(result.message, 'error');
                    hideLoading();
                }

            } catch (error) {
                console.error('ì°¨íŠ¸ ë¶„ì„ ì‹œì‘ ì‹¤íŒ¨:', error);
                showAlert('ì°¨íŠ¸ ë¶„ì„ ì‹œì‘ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.', 'error');
                hideLoading();
            }
        }

        // ìƒíƒœ í™•ì¸
        async function checkStatus() {
            try {
                const response = await fetch('/top-rate/status');
                const status = await response.json();

                updateStatusDisplay(status);
                updateButtonStates(status);

                // ì™„ë£Œ ìƒíƒœ í™•ì¸
                if (status.crawl_status === 'completed') {
                    hideLoading();
                    await loadResults();
                }

            } catch (error) {
                console.error('ìƒíƒœ í™•ì¸ ì‹¤íŒ¨:', error);
            }
        }

        // ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateStatusDisplay(status) {
            document.getElementById('totalSectors').textContent = status.statistics.total_sectors;
            document.getElementById('totalNewsStocks').textContent = status.statistics.total_news_stocks;
            document.getElementById('totalAnalyzedStocks').textContent = status.statistics.total_analyzed_stocks;
            document.getElementById('newHighStocks').textContent = status.statistics.new_high_stocks_count;
        }

        // ë²„íŠ¼ ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateButtonStates(status) {
            const aiBtn = document.getElementById('aiBtn');
            const chartBtn = document.getElementById('chartBtn');

            if (status.crawl_status === 'completed') {
                aiBtn.disabled = false;
                chartBtn.disabled = false;
            }
        }

        // ê²°ê³¼ ë¡œë“œ
        async function loadResults() {
            try {
                const response = await fetch('/top-rate/results');
                const result = await response.json();

                if (result.success) {
                    displaySectors(result.data.sectors);

                    if (result.data.ai_analysis) {
                        displayAIAnalysis(result.data.ai_analysis);
                    }

                    if (result.data.charts && result.data.charts.length > 0) {
                        displayCharts(result.data.charts);
                    }
                }

            } catch (error) {
                console.error('ê²°ê³¼ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì—…ì¢… ë°ì´í„° í‘œì‹œ
        function displaySectors(sectors) {
            const sectorList = document.getElementById('sectorList');
            const stockTableBody = document.getElementById('stockTableBody');

            sectorList.innerHTML = '';
            stockTableBody.innerHTML = '';

            // ì—…ì¢… ì¹´ë“œ ìƒì„±
            sectors.forEach(sector => {
                const sectorCard = document.createElement('div');
                sectorCard.className = 'sector-item';
                sectorCard.innerHTML = `
                    <div class="sector-name">${sector.sector_name}</div>
                    <div class="sector-change ${sector.is_positive ? 'positive' : 'negative'}">${sector.formatted_change_rate}</div>
                    <div>ìƒìœ„ì¢…ëª©: ${sector.top_stocks.map(s => s.stock_name).join(', ')}</div>
                `;
                sectorList.appendChild(sectorCard);

                // ì¢…ëª© í…Œì´ë¸” í–‰ ìƒì„±
                sector.top_stocks.forEach(stock => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td><strong>${stock.stock_name}</strong></td>
                        <td>${sector.sector_name}</td>
                        <td>${stock.formatted_price}<br><span class="${stock.is_positive ? 'positive' : 'negative'}">${stock.formatted_change_rate}</span></td>
                        <td>${stock.volume.toLocaleString()}ì£¼</td>
                        <td>
                            <div class="supply-indicator">
                                ${stock.supply_badges.map(badge => `<span class="supply-badge ${badge.class}">${badge.text}</span>`).join('')}
                            </div>
                        </td>
                        <td>
                            <div class="supply-stage">
                                <span class="stage-icon stage-${stock.supply_stage}">${stock.supply_stage}</span>
                                ${getStageText(stock.supply_stage)}
                            </div>
                        </td>
                        <td>
                            <div class="total-score">
                                <div class="score-circle ${getScoreClass(stock.score_grade)}">${stock.score_grade}</div>
                                <small>${stock.total_score}ì </small>
                            </div>
                        </td>
                        <td>
                            <div class="news-links">
                                ${stock.news_list.map(news => `<a href="${news.url}" class="news-link" target="_blank">${news.title}</a>`).join('')}
                            </div>
                        </td>
                    `;
                    stockTableBody.appendChild(row);
                });
            });

            document.getElementById('sectorsSection').style.display = 'block';
            document.getElementById('stockTable').style.display = 'table';
        }

        // AI ë¶„ì„ ê²°ê³¼ í‘œì‹œ
        function displayAIAnalysis(aiAnalysis) {
            const content = document.getElementById('aiAnalysisContent');
            content.innerHTML = `
                <p><strong>ğŸ”¥ í•µì‹¬ íˆ¬ì í¬ì¸íŠ¸</strong></p>
                <p>${aiAnalysis.summary}</p>

                <div style="margin: 15px 0;">
                    ${aiAnalysis.keywords.map(keyword => `<span class="keyword-tag">${keyword}</span>`).join('')}
                </div>

                <p><strong>ğŸ“Š ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„:</strong></p>
                <p>${aiAnalysis.supply_analysis}</p>

                ${aiAnalysis.key_points.length > 0 ? `
                <p><strong>ğŸ’¡ ì£¼ìš” í¬ì¸íŠ¸:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${aiAnalysis.key_points.map(point => `<li>${point}</li>`).join('')}
                </ul>
                ` : ''}

                ${aiAnalysis.risk_factors.length > 0 ? `
                <p><strong>âš ï¸ ì£¼ì˜ì‚¬í•­:</strong></p>
                <ul style="margin: 10px 0; padding-left: 20px;">
                    ${aiAnalysis.risk_factors.map(risk => `<li>${risk}</li>`).join('')}
                </ul>
                ` : ''}

                <p><strong>ğŸ¯ íˆ¬ì ì „ëµ:</strong> ${aiAnalysis.investment_recommendation}</p>
                <p><strong>ì‹ ë¢°ë„:</strong> ${aiAnalysis.confidence_score}%</p>
            `;

            document.getElementById('aiAnalysis').style.display = 'block';
        }

        // ì°¨íŠ¸ í‘œì‹œ
        function displayCharts(charts) {
            const chartGrid = document.getElementById('chartGrid');
            chartGrid.innerHTML = '';

            charts.forEach((chartData, index) => {
                // ê°€ê²© ì°¨íŠ¸
                const priceChartContainer = document.createElement('div');
                priceChartContainer.className = 'chart-item';
                priceChartContainer.innerHTML = `
                    <div class="chart-title">${chartData.stock_name} - ê°€ê²© ì§‘ì¤‘êµ¬ê°„</div>
                    <canvas id="priceChart${index}" width="400" height="300"></canvas>
                `;
                chartGrid.appendChild(priceChartContainer);

                // ìˆ˜ê¸‰ ì°¨íŠ¸
                const supplyChartContainer = document.createElement('div');
                supplyChartContainer.className = 'chart-item';
                supplyChartContainer.innerHTML = `
                    <div class="chart-title">${chartData.stock_name} - ìˆ˜ê¸‰ ë¶„ì„</div>
                    <canvas id="supplyChart${index}" width="400" height="300"></canvas>
                `;
                chartGrid.appendChild(supplyChartContainer);

                // ì°¨íŠ¸ ìƒì„±
                createPriceChart(`priceChart${index}`, chartData.price_chart);
                createSupplyChart(`supplyChart${index}`, chartData.supply_chart);
            });

            document.getElementById('chartSection').style.display = 'block';
        }

        // ê°€ê²© ì°¨íŠ¸ ìƒì„±
        function createPriceChart(canvasId, chartData) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'line',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        // ìˆ˜ê¸‰ ì°¨íŠ¸ ìƒì„±
        function createSupplyChart(canvasId, chartData) {
            if (!chartData || !chartData.labels) return;

            const ctx = document.getElementById(canvasId).getContext('2d');
            new Chart(ctx, {
                type: 'bar',
                data: chartData,
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });
        }

        // í—¬í¼ í•¨ìˆ˜ë“¤
        function getStageText(stage) {
            const stages = {
                1: 'ê¸°ë°˜ë‹¨ê³„',
                2: 'íˆ¬ì‹ ë‹¨ê³„',
                3: 'ê°œì¸ë‹¨ê³„'
            };
            return stages[stage] || 'ë¶„ì„ì¤‘';
        }

        function getScoreClass(grade) {
            const classes = {
                'A+': 'score-excellent',
                'A': 'score-good',
                'B+': 'score-good',
                'B': 'score-warning',
                'C': 'score-warning',
                'D': 'score-danger'
            };
            return classes[grade] || 'score-warning';
        }

        // ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì‹œì‘
        function startStatusMonitoring() {
            statusCheckInterval = setInterval(checkStatus, 3000); // 3ì´ˆë§ˆë‹¤ í™•ì¸
        }

        // ìƒíƒœ ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
        function stopStatusMonitoring() {
            if (statusCheckInterval) {
                clearInterval(statusCheckInterval);
            }
        }

        // ì—…ë°ì´íŠ¸ ìŠ¤ì¼€ì¤„ ì„¤ì •
        function setUpdateSchedule(schedule) {
            console.log('ì—…ë°ì´íŠ¸ ìŠ¤ì¼€ì¤„ ì„¤ì •:', schedule);
            // ì‹¤ì œ êµ¬í˜„ì‹œ ì„œë²„ì— ìŠ¤ì¼€ì¤„ ì„¤ì • ì „ì†¡
        }

        // ë¡œë”© í‘œì‹œ
        function showLoading(message = 'ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...') {
            document.getElementById('loadingMessage').textContent = message;
            document.getElementById('loadingState').style.display = 'block';
        }

        // ë¡œë”© ìˆ¨ê¹€
        function hideLoading() {
            document.getElementById('loadingState').style.display = 'none';
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showAlert(message, type = 'info') {
            const alertElement = document.getElementById('alertMessage');
            const alertText = document.getElementById('alertText');

            alertText.textContent = message;
            alertElement.className = `alert alert-${type}`;
            alertElement.style.display = 'block';

            // 5ì´ˆ í›„ ìë™ ìˆ¨ê¹€
            setTimeout(hideAlert, 5000);
        }

        // ì•Œë¦¼ ìˆ¨ê¹€
        function hideAlert() {
            document.getElementById('alertMessage').style.display = 'none';
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œì‹œ ì •ë¦¬
        window.addEventListener('beforeunload', function() {
            stopStatusMonitoring();
        });
    </script>
</body>
</html>