#!/usr/bin/env python3
# -*- coding: utf-8 -*-

"""
ì‹¤ì „ ì°¨íŠ¸+ìˆ˜ê¸‰ ë¶„ì„ í…ŒìŠ¤íŠ¸ íŒŒì¼
- 52ì£¼ ì‹ ê³ ê°€ í•„í„°ë§
- ì‹ ê³ ê°€ ì ìˆ˜ (5ì¼/20ì¼/60ì¼)
- ì‹¤ì „ ìˆ˜ê¸‰ ë¶„ì„ (ì™¸êµ­ì¸ 5ì¼ íŒ¨í„´, ê°œì¸ ì—­ì§€í‘œ)
- ì¢…í•© ì ìˆ˜ ì‚°ì¶œ
"""

import sys
import os
import json
import time
from datetime import datetime, timedelta
from typing import List, Dict, Optional
import requests
from bs4 import BeautifulSoup
import re

# í”„ë¡œì íŠ¸ ë£¨íŠ¸ ì¶”ê°€
sys.path.append(os.path.dirname(os.path.abspath(__file__)))

from modules.top_rate_analysi.database import TopRateDatabase


class ChartSupplyAnalyzer:
    """ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„ê¸°"""

    def __init__(self):
        self.db = TopRateDatabase()
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'
        }

    def run_comprehensive_analysis(self, analysis_date='2025-08-12'):
        """ì¢…í•© ë¶„ì„ ì‹¤í–‰"""
        print("ğŸš€ ì‹¤ì „ ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„ ì‹œì‘")
        print("=" * 80)
        print(f"ğŸ“… ë¶„ì„ ë‚ ì§œ: {analysis_date}")
        print("ğŸ¯ ë¶„ì„ ìˆœì„œ: 52ì£¼ì‹ ê³ ê°€ í•„í„°ë§ â†’ ì°¨íŠ¸ë¶„ì„ â†’ ìˆ˜ê¸‰ë¶„ì„ â†’ ì¢…í•©ì ìˆ˜")
        print("=" * 80)

        try:
            # 1ë‹¨ê³„: ë¶„ì„ ëŒ€ìƒ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¡°íšŒ
            print("\nğŸ“‹ 1ë‹¨ê³„: ë¶„ì„ ëŒ€ìƒ ì¢…ëª© ì¡°íšŒ")
            print("â”€" * 60)

            # AI ë¶„ì„ ê²°ê³¼ì—ì„œ ì¢…ëª© ë¦¬ìŠ¤íŠ¸ ì¶”ì¶œ
            ai_results = self.db.get_ai_analysis(analysis_date)
            if not ai_results:
                print(f"âŒ {analysis_date} AI ë¶„ì„ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤")
                return False

            ì¢…ëª©_ë¦¬ìŠ¤íŠ¸ = [(r['stock_code'], r['stock_name']) for r in ai_results]
            print(f"âœ… ì´ {len(ì¢…ëª©_ë¦¬ìŠ¤íŠ¸)}ê°œ ì¢…ëª© ë°œê²¬")

            # 2ë‹¨ê³„: 52ì£¼ ì‹ ê³ ê°€ í•„í„°ë§
            print(f"\nğŸ“ˆ 2ë‹¨ê³„: 52ì£¼ ì‹ ê³ ê°€ í•„í„°ë§")
            print("â”€" * 60)

            ì‹ ê³ ê°€_ì¢…ëª©ë“¤ = self.filter_52week_high_stocks(ì¢…ëª©_ë¦¬ìŠ¤íŠ¸)

            if not ì‹ ê³ ê°€_ì¢…ëª©ë“¤:
                print("âŒ 52ì£¼ ì‹ ê³ ê°€ ì¡°ê±´ì„ ë§Œì¡±í•˜ëŠ” ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤")
                return False

            print(f"âœ… 52ì£¼ ì‹ ê³ ê°€ í•„í„°ë§ ì™„ë£Œ: {len(ì‹ ê³ ê°€_ì¢…ëª©ë“¤)}ê°œ ì¢…ëª©")
            for stock in ì‹ ê³ ê°€_ì¢…ëª©ë“¤[:5]:  # ìƒìœ„ 5ê°œë§Œ ë¯¸ë¦¬ë³´ê¸°
                print(f"   â€¢ {stock['ì¢…ëª©ëª…']} ({stock['ì¢…ëª©ì½”ë“œ']}): ì‹ ê³ ê°€ ë‹¬ì„±ì¼ {stock['ì‹ ê³ ê°€ë‹¬ì„±ì¼']}")

            if len(ì‹ ê³ ê°€_ì¢…ëª©ë“¤) > 5:
                print(f"   ... ì™¸ {len(ì‹ ê³ ê°€_ì¢…ëª©ë“¤) - 5}ê°œ ì¢…ëª©")

            # 3ë‹¨ê³„: ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„
            print(f"\nğŸ” 3ë‹¨ê³„: ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„")
            print("â”€" * 60)

            ìµœì¢…_ë¶„ì„_ê²°ê³¼ë“¤ = []

            for i, stock_info in enumerate(ì‹ ê³ ê°€_ì¢…ëª©ë“¤):
                ì¢…ëª©ì½”ë“œ = stock_info['ì¢…ëª©ì½”ë“œ']
                ì¢…ëª©ëª… = stock_info['ì¢…ëª©ëª…']

                print(f"\n[{i + 1}/{len(ì‹ ê³ ê°€_ì¢…ëª©ë“¤)}] {ì¢…ëª©ëª…} ({ì¢…ëª©ì½”ë“œ}) ë¶„ì„ ì¤‘...")
                print("â”€" * 50)

                try:
                    # ì°¨íŠ¸ ë¶„ì„ + ì‹ ê³ ê°€ ì ìˆ˜
                    ì°¨íŠ¸_ê²°ê³¼ = self.analyze_chart_and_new_high_score(ì¢…ëª©ì½”ë“œ, ì¢…ëª©ëª…)

                    # ì‹¤ì „ ìˆ˜ê¸‰ ë¶„ì„
                    ìˆ˜ê¸‰_ê²°ê³¼ = self.analyze_practical_supply_demand(ì¢…ëª©ì½”ë“œ, ì¢…ëª©ëª…)

                    # ì¢…í•© ì ìˆ˜ ê³„ì‚°
                    ì¢…í•©_ê²°ê³¼ = self.calculate_comprehensive_score(
                        stock_info, ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼
                    )

                    ìµœì¢…_ë¶„ì„_ê²°ê³¼ë“¤.append({
                        "ì¢…ëª©ì •ë³´": stock_info,
                        "ì°¨íŠ¸ë¶„ì„": ì°¨íŠ¸_ê²°ê³¼,
                        "ìˆ˜ê¸‰ë¶„ì„": ìˆ˜ê¸‰_ê²°ê³¼,
                        "ì¢…í•©í‰ê°€": ì¢…í•©_ê²°ê³¼
                    })

                    # ê²°ê³¼ ì¶œë ¥
                    self._print_single_analysis_result(ì¢…ëª©ëª…, ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼, ì¢…í•©_ê²°ê³¼)

                except Exception as e:
                    print(f"   âŒ {ì¢…ëª©ëª…} ë¶„ì„ ì‹¤íŒ¨: {e}")
                    continue

                # ì ì‹œ ëŒ€ê¸° (API ë¶€í•˜ ë°©ì§€)
                time.sleep(1)

            # 4ë‹¨ê³„: ìµœì¢… ê²°ê³¼ ìš”ì•½ ë° DB ì €ì¥
            print(f"\nğŸ¯ 4ë‹¨ê³„: ìµœì¢… ë¶„ì„ ê²°ê³¼ ë° DB ì €ì¥")
            print("=" * 80)

            if ìµœì¢…_ë¶„ì„_ê²°ê³¼ë“¤:
                self._print_final_summary(ìµœì¢…_ë¶„ì„_ê²°ê³¼ë“¤)

                # DB ìë™ ì €ì¥ (í•„ìˆ˜)
                print(f"\nğŸ’¾ ë¶„ì„ ê²°ê³¼ DB ì €ì¥ ì¤‘...")
                self._save_analysis_results(analysis_date, ìµœì¢…_ë¶„ì„_ê²°ê³¼ë“¤)

                return True
            else:
                print("âŒ ë¶„ì„ ì™„ë£Œëœ ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤")
                return False

        except Exception as e:
            print(f"âŒ ì¢…í•© ë¶„ì„ ì‹¤íŒ¨: {e}")
            import traceback
            traceback.print_exc()
            return False

    def filter_52week_high_stocks(self, ì¢…ëª©_ë¦¬ìŠ¤íŠ¸: List[tuple]) -> List[Dict]:
        """52ì£¼ ì‹ ê³ ê°€ ì¢…ëª© í•„í„°ë§"""
        print("ğŸ” 52ì£¼ ì‹ ê³ ê°€ ì¡°ê±´ í™•ì¸ ì¤‘...")

        ì‹ ê³ ê°€_ì¢…ëª©ë“¤ = []

        for i, (ì¢…ëª©ì½”ë“œ, ì¢…ëª©ëª…) in enumerate(ì¢…ëª©_ë¦¬ìŠ¤íŠ¸):
            try:
                print(f"   [{i + 1}/{len(ì¢…ëª©_ë¦¬ìŠ¤íŠ¸)}] {ì¢…ëª©ëª…} í™•ì¸ ì¤‘...", end="")

                # 1ë…„ì¹˜ ì¼ë´‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ëª¨ì˜ ë°ì´í„°)
                ì¼ë´‰_ë°ì´í„° = self._get_daily_price_data(ì¢…ëª©ì½”ë“œ, 252)

                if not ì¼ë´‰_ë°ì´í„°:
                    print(" âŒ ë°ì´í„° ì—†ìŒ")
                    continue

                # 52ì£¼ ìµœê³ ê°€ ê³„ì‚°
                ìµœê³ ê°€_52ì£¼ = max([day['high'] for day in ì¼ë´‰_ë°ì´í„°])
                í˜„ì¬ê°€ = ì¼ë´‰_ë°ì´í„°[0]['close']

                # ìµœê·¼ 1ë…„ ë‚´ 52ì£¼ ì‹ ê³ ê°€ ë‹¬ì„± ì—¬ë¶€ í™•ì¸
                ì‹ ê³ ê°€_ë‹¬ì„±ì¼ = None
                for day in ì¼ë´‰_ë°ì´í„°[:252]:  # ìµœê·¼ 1ë…„
                    if day['high'] >= ìµœê³ ê°€_52ì£¼ * 0.99:  # 99% ì´ìƒë„ ì‹ ê³ ê°€ë¡œ ì¸ì •
                        ì‹ ê³ ê°€_ë‹¬ì„±ì¼ = day['date']
                        break

                if ì‹ ê³ ê°€_ë‹¬ì„±ì¼:
                    í˜„ì¬ê°€_vs_52ì£¼ê³ ê°€ = (í˜„ì¬ê°€ / ìµœê³ ê°€_52ì£¼ - 1) * 100

                    ì‹ ê³ ê°€_ì¢…ëª©ë“¤.append({
                        "ì¢…ëª©ì½”ë“œ": ì¢…ëª©ì½”ë“œ,
                        "ì¢…ëª©ëª…": ì¢…ëª©ëª…,
                        "52ì£¼ìµœê³ ê°€": ìµœê³ ê°€_52ì£¼,
                        "í˜„ì¬ê°€": í˜„ì¬ê°€,
                        "ì‹ ê³ ê°€ë‹¬ì„±ì¼": ì‹ ê³ ê°€_ë‹¬ì„±ì¼,
                        "í˜„ì¬ê°€_vs_52ì£¼ê³ ê°€": í˜„ì¬ê°€_vs_52ì£¼ê³ ê°€
                    })
                    print(f" âœ… ì‹ ê³ ê°€ ë‹¬ì„± ({ì‹ ê³ ê°€_ë‹¬ì„±ì¼})")
                else:
                    print(" âŒ ì‹ ê³ ê°€ ë¯¸ë‹¬ì„±")

            except Exception as e:
                print(f" âŒ ì˜¤ë¥˜: {e}")
                continue

        # ì‹ ê³ ê°€ ë‹¬ì„±ì¼ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœê·¼ìˆœ)
        ì‹ ê³ ê°€_ì¢…ëª©ë“¤.sort(key=lambda x: x['ì‹ ê³ ê°€ë‹¬ì„±ì¼'], reverse=True)

        return ì‹ ê³ ê°€_ì¢…ëª©ë“¤

    def analyze_chart_and_new_high_score(self, ì¢…ëª©ì½”ë“œ: str, ì¢…ëª©ëª…: str) -> Dict:
        """ì°¨íŠ¸ ë¶„ì„ + ì‹ ê³ ê°€ ì ìˆ˜"""

        # ê° ê¸°ê°„ë³„ ì¼ë´‰ ë°ì´í„°
        ì¼ë´‰_5ì¼ = self._get_daily_price_data(ì¢…ëª©ì½”ë“œ, 5)
        ì¼ë´‰_20ì¼ = self._get_daily_price_data(ì¢…ëª©ì½”ë“œ, 20)
        ì¼ë´‰_60ì¼ = self._get_daily_price_data(ì¢…ëª©ì½”ë“œ, 60)

        if not ì¼ë´‰_60ì¼:
            raise ValueError("ì°¨íŠ¸ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤")

        í˜„ì¬ê°€ = ì¼ë´‰_5ì¼[0]['close']

        # ê° ê¸°ê°„ë³„ ìµœê³ ê°€
        ìµœê³ ê°€_5ì¼ = max([day['high'] for day in ì¼ë´‰_5ì¼])
        ìµœê³ ê°€_20ì¼ = max([day['high'] for day in ì¼ë´‰_20ì¼])
        ìµœê³ ê°€_60ì¼ = max([day['high'] for day in ì¼ë´‰_60ì¼])

        # ì‹ ê³ ê°€ ì—¬ë¶€ ë° ì ìˆ˜ ê³„ì‚°
        ì‹ ê³ ê°€_ì ìˆ˜ = 0
        ì‹ ê³ ê°€_ìƒíƒœ = []

        if í˜„ì¬ê°€ >= ìµœê³ ê°€_5ì¼ * 0.995:  # 99.5% ì´ìƒë„ ì‹ ê³ ê°€ë¡œ ì¸ì •
            ì‹ ê³ ê°€_ì ìˆ˜ += 5
            ì‹ ê³ ê°€_ìƒíƒœ.append("5ì¼ì‹ ê³ ê°€")

        if í˜„ì¬ê°€ >= ìµœê³ ê°€_20ì¼ * 0.995:
            ì‹ ê³ ê°€_ì ìˆ˜ += 15
            ì‹ ê³ ê°€_ìƒíƒœ.append("20ì¼ì‹ ê³ ê°€")

        if í˜„ì¬ê°€ >= ìµœê³ ê°€_60ì¼ * 0.995:
            ì‹ ê³ ê°€_ì ìˆ˜ += 25
            ì‹ ê³ ê°€_ìƒíƒœ.append("60ì¼ì‹ ê³ ê°€")

        # ì—°ì† ì‹ ê³ ê°€ ë³´ë„ˆìŠ¤
        if len(ì‹ ê³ ê°€_ìƒíƒœ) >= 3:  # 5ì¼+20ì¼+60ì¼ ëª¨ë‘
            ì‹ ê³ ê°€_ì ìˆ˜ += 10
            ì‹ ê³ ê°€_ìƒíƒœ.append("ì™„ì „ì‹ ê³ ê°€")

        # ì´ë™í‰ê· ì„  ë¶„ì„
        ì´ë™í‰ê· _ë¶„ì„ = self._calculate_moving_averages(ì¼ë´‰_60ì¼)

        # ì°¨íŠ¸ íŒ¨í„´ ë¶„ì„ (ê°„ë‹¨ ë²„ì „)
        ì°¨íŠ¸_íŒ¨í„´ = self._analyze_chart_pattern(ì¼ë´‰_60ì¼)

        return {
            "ì‹ ê³ ê°€_ì ìˆ˜": ì‹ ê³ ê°€_ì ìˆ˜,
            "ì‹ ê³ ê°€_ìƒíƒœ": ì‹ ê³ ê°€_ìƒíƒœ,
            "ì‹ ê³ ê°€_ì„¸ë¶€": {
                "5ì¼ì‹ ê³ ê°€": í˜„ì¬ê°€ >= ìµœê³ ê°€_5ì¼ * 0.995,
                "20ì¼ì‹ ê³ ê°€": í˜„ì¬ê°€ >= ìµœê³ ê°€_20ì¼ * 0.995,
                "60ì¼ì‹ ê³ ê°€": í˜„ì¬ê°€ >= ìµœê³ ê°€_60ì¼ * 0.995,
                "í˜„ì¬ê°€": í˜„ì¬ê°€,
                "5ì¼ìµœê³ ê°€": ìµœê³ ê°€_5ì¼,
                "20ì¼ìµœê³ ê°€": ìµœê³ ê°€_20ì¼,
                "60ì¼ìµœê³ ê°€": ìµœê³ ê°€_60ì¼
            },
            "ì´ë™í‰ê· _ë¶„ì„": ì´ë™í‰ê· _ë¶„ì„,
            "ì°¨íŠ¸_íŒ¨í„´": ì°¨íŠ¸_íŒ¨í„´
        }

    def analyze_practical_supply_demand(self, ì¢…ëª©ì½”ë“œ: str, ì¢…ëª©ëª…: str) -> Dict:
        """ì‹¤ì „ ìˆ˜ê¸‰ ë¶„ì„ (ì™¸êµ­ì¸ 5ì¼ íŒ¨í„´ + ê°œì¸ ì—­ì§€í‘œ)"""

        # ìˆ˜ê¸‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ëª¨ì˜ ë°ì´í„°)
        ìˆ˜ê¸‰_ë°ì´í„° = self._get_supply_demand_data(ì¢…ëª©ì½”ë“œ, 365)

        if not ìˆ˜ê¸‰_ë°ì´í„°:
            # ìˆ˜ê¸‰ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë°˜í™˜
            return self._get_default_supply_analysis()

        # ì™¸êµ­ì¸ íŒ¨í„´ ë¶„ì„
        ì™¸êµ­ì¸_ë¶„ì„ = self._analyze_foreign_pattern(ìˆ˜ê¸‰_ë°ì´í„°)

        # ê¸°ê´€ ë¶„ì„ (ê³ ê¸‰ vs ì¼ë°˜)
        ê¸°ê´€_ë¶„ì„ = self._analyze_institution_pattern(ìˆ˜ê¸‰_ë°ì´í„°)

        # ê°œì¸ ì—­ì§€í‘œ ë¶„ì„
        ê°œì¸_ë¶„ì„ = self._analyze_retail_pattern(ìˆ˜ê¸‰_ë°ì´í„°)

        # ìˆ˜ê¸‰ ìœ„í—˜ë„ í‰ê°€
        ìœ„í—˜ë„_í‰ê°€ = self._assess_supply_risk(ì™¸êµ­ì¸_ë¶„ì„, ê¸°ê´€_ë¶„ì„, ê°œì¸_ë¶„ì„)

        # ìˆ˜ê¸‰ ì ìˆ˜ ê³„ì‚°
        ìˆ˜ê¸‰_ì ìˆ˜ = self._calculate_supply_score(ì™¸êµ­ì¸_ë¶„ì„, ê¸°ê´€_ë¶„ì„, ê°œì¸_ë¶„ì„, ìœ„í—˜ë„_í‰ê°€)

        return {
            "ì™¸êµ­ì¸_ë¶„ì„": ì™¸êµ­ì¸_ë¶„ì„,
            "ê¸°ê´€_ë¶„ì„": ê¸°ê´€_ë¶„ì„,
            "ê°œì¸_ë¶„ì„": ê°œì¸_ë¶„ì„,
            "ìœ„í—˜ë„_í‰ê°€": ìœ„í—˜ë„_í‰ê°€,
            "ìˆ˜ê¸‰_ì ìˆ˜": ìˆ˜ê¸‰_ì ìˆ˜,
            "í•µì‹¬_ì‹œì‚¬ì ": self._get_supply_insights(ì™¸êµ­ì¸_ë¶„ì„, ê¸°ê´€_ë¶„ì„, ê°œì¸_ë¶„ì„)
        }

    def calculate_comprehensive_score(self, stock_info: Dict, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> Dict:
        """ì¢…í•© ì ìˆ˜ ê³„ì‚°"""

        ì ìˆ˜_êµ¬ì„± = {
            "ì‹ ê³ ê°€_ì ìˆ˜": ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ì ìˆ˜'],  # ìµœëŒ€ 55ì 
            "ìˆ˜ê¸‰_ì ìˆ˜": ìˆ˜ê¸‰_ê²°ê³¼['ìˆ˜ê¸‰_ì ìˆ˜'],  # ìµœëŒ€ 50ì 
            "ì°¨íŠ¸_ë³´ë„ˆìŠ¤": self._calculate_chart_bonus(ì°¨íŠ¸_ê²°ê³¼),  # ìµœëŒ€ 15ì 
        }

        ì´ì  = sum(ì ìˆ˜_êµ¬ì„±.values())
        ìµœì¢…ì ìˆ˜ = min(100, max(0, ì´ì ))

        # íˆ¬ì ì˜ê²¬ ê²°ì •
        if ìµœì¢…ì ìˆ˜ >= 80 and ìˆ˜ê¸‰_ê²°ê³¼['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜ë„'] == 'ë‚®ìŒ':
            íˆ¬ìì˜ê²¬ = "ê°•ë ¥ë§¤ìˆ˜"
        elif ìµœì¢…ì ìˆ˜ >= 65:
            íˆ¬ìì˜ê²¬ = "ë§¤ìˆ˜"
        elif ìµœì¢…ì ìˆ˜ >= 45:
            íˆ¬ìì˜ê²¬ = "ê´€ì‹¬"
        else:
            íˆ¬ìì˜ê²¬ = "ê´€ë§"

        # ì‹ ë¢°ë„ ê³„ì‚°
        ì‹ ë¢°ë„ = self._calculate_confidence(ì ìˆ˜_êµ¬ì„±, ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼)

        # ìŠ¤ë§ˆíŠ¸ ì½”ë©˜íŠ¸ ìƒì„±
        ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸ = self._generate_smart_comment(ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼, ì´ì , íˆ¬ìì˜ê²¬)

        return {
            "ì ìˆ˜_êµ¬ì„±": ì ìˆ˜_êµ¬ì„±,
            "ì´ì ": ì´ì ,
            "ìµœì¢…ì ìˆ˜": ìµœì¢…ì ìˆ˜,
            "íˆ¬ìì˜ê²¬": íˆ¬ìì˜ê²¬,
            "ì‹ ë¢°ë„": ì‹ ë¢°ë„,
            "ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸": ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸,
            "í•µì‹¬_ê°•ì ": self._identify_key_strengths(ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼),
            "ì£¼ì˜ì‚¬í•­": self._identify_risks(ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼)
        }

    def _get_daily_price_data(self, ì¢…ëª©ì½”ë“œ: str, days: int) -> List[Dict]:
        """ì¼ë´‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (í¬ë¡¤ë§ DB í˜„ì¬ê°€ í™œìš©)"""

        try:
            # 1. ì‹¤ì œ ì°¨íŠ¸ ë°ì´í„°ê°€ ìˆëŠ”ì§€ í™•ì¸ (ì¶”í›„ êµ¬í˜„)
            # chart_data = self._fetch_real_chart_data(ì¢…ëª©ì½”ë“œ, days)
            # if chart_data:
            #     return chart_data

            # 2. ì°¨íŠ¸ ë°ì´í„°ê°€ ì—†ìœ¼ë©´ í¬ë¡¤ë§ DBì—ì„œ í˜„ì¬ê°€ ê°€ì ¸ì™€ì„œ ëª¨ì˜ ë°ì´í„° ìƒì„±
            current_price = self._get_current_price_from_crawling_db(ì¢…ëª©ì½”ë“œ)

            if current_price:
                return self._generate_mock_chart_data(current_price, days)
            else:
                # 3. í¬ë¡¤ë§ DBì—ë„ ì—†ìœ¼ë©´ ê¸°ë³¸ ëª¨ì˜ ë°ì´í„°
                return self._generate_default_mock_data(days)

        except Exception as e:
            print(f"   âš ï¸ ì°¨íŠ¸ ë°ì´í„° ì˜¤ë¥˜ ({ì¢…ëª©ì½”ë“œ}): {e}")
            return self._generate_default_mock_data(days)

    def _get_current_price_from_crawling_db(self, ì¢…ëª©ì½”ë“œ: str) -> Optional[int]:
        """í¬ë¡¤ë§ DBì—ì„œ í˜„ì¬ê°€ ê°€ì ¸ì˜¤ê¸°"""

        try:
            # ìµœì‹  í…Œë§ˆ í…Œì´ë¸”ì—ì„œ í˜„ì¬ê°€ ì¡°íšŒ
            today = datetime.now().strftime('%Y%m%d')
            table_name = f"theme_{today}"

            connection = self.db.get_connection(self.db.crawling_db)
            cursor = connection.cursor()

            query = f"""
            SELECT price, change_rate, volume 
            FROM {table_name} 
            WHERE stock_code = %s 
            LIMIT 1
            """

            cursor.execute(query, (ì¢…ëª©ì½”ë“œ,))
            result = cursor.fetchone()

            cursor.close()
            connection.close()

            if result:
                print(f" [í¬ë¡¤ë§DB í˜„ì¬ê°€: {result[0]:,}ì›]")
                return result[0]

            return None

        except Exception as e:
            # ì˜¤ëŠ˜ í…Œì´ë¸”ì´ ì—†ìœ¼ë©´ ì–´ì œ ë˜ëŠ” ìµœì‹  í…Œì´ë¸” ì°¾ê¸°
            try:
                return self._get_latest_price_from_any_table(ì¢…ëª©ì½”ë“œ)
            except:
                return None

    def _get_latest_price_from_any_table(self, ì¢…ëª©ì½”ë“œ: str) -> Optional[int]:
        """ê°€ì¥ ìµœì‹  í…Œë§ˆ í…Œì´ë¸”ì—ì„œ í˜„ì¬ê°€ ì°¾ê¸°"""

        try:
            connection = self.db.get_connection(self.db.crawling_db)
            cursor = connection.cursor()

            # í…Œë§ˆ í…Œì´ë¸”ë“¤ ì¡°íšŒ
            cursor.execute("SHOW TABLES LIKE 'theme_%'")
            tables = [table[0] for table in cursor.fetchall()]

            # ìµœì‹  í…Œì´ë¸”ë¶€í„° ê²€ìƒ‰
            tables.sort(reverse=True)

            for table in tables[:5]:  # ìµœê·¼ 5ê°œ í…Œì´ë¸”ë§Œ í™•ì¸
                try:
                    query = f"SELECT price FROM {table} WHERE stock_code = %s LIMIT 1"
                    cursor.execute(query, (ì¢…ëª©ì½”ë“œ,))
                    result = cursor.fetchone()

                    if result:
                        print(f" [DBí…Œì´ë¸” {table}: {result[0]:,}ì›]")
                        cursor.close()
                        connection.close()
                        return result[0]
                except:
                    continue

            cursor.close()
            connection.close()
            return None

        except Exception as e:
            return None

    def _generate_mock_chart_data(self, current_price: int, days: int) -> List[Dict]:
        """í˜„ì¬ê°€ ê¸°ì¤€ ëª¨ì˜ ì°¨íŠ¸ ë°ì´í„° ìƒì„±"""

        import random

        chart_data = []
        base_price = current_price

        # ê³¼ê±°ë¶€í„° í˜„ì¬ê¹Œì§€ ì—­ìˆœìœ¼ë¡œ ìƒì„±
        for i in range(days - 1, -1, -1):
            date = datetime.now() - timedelta(days=i)

            if i == 0:  # ì˜¤ëŠ˜ (ê°€ì¥ ìµœê·¼)
                close = current_price
                high = close * random.uniform(1.0, 1.02)
                low = close * random.uniform(0.98, 1.0)
                open_price = close * random.uniform(0.99, 1.01)
            else:
                # í˜„ì¬ê°€ ê¸°ì¤€ìœ¼ë¡œ ì—­ì‚°í•˜ì—¬ ê³¼ê±° ê°€ê²© ì¶”ì •
                variation = random.uniform(0.95, 1.05)
                close = int(base_price * variation)
                high = int(close * random.uniform(1.0, 1.03))
                low = int(close * random.uniform(0.97, 1.0))
                open_price = int(close * random.uniform(0.99, 1.01))
                base_price = close

            volume = random.randint(500000, 3000000)

            chart_data.append({
                'date': date.strftime('%Y-%m-%d'),
                'open': open_price,
                'high': high,
                'low': low,
                'close': close,
                'volume': volume
            })

        # ìµœì‹  ë‚ ì§œë¶€í„° ì •ë ¬ (index 0ì´ ê°€ì¥ ìµœê·¼)
        chart_data.reverse()
        return chart_data

    def _generate_default_mock_data(self, days: int) -> List[Dict]:
        """ê¸°ë³¸ ëª¨ì˜ ë°ì´í„° ìƒì„±"""

        import random

        chart_data = []
        base_price = random.randint(50000, 100000)  # ê¸°ë³¸ ê°€ê²©ëŒ€

        for i in range(days):
            date = datetime.now() - timedelta(days=i)

            variation = random.uniform(0.98, 1.02)
            close = int(base_price * variation)
            high = int(close * random.uniform(1.0, 1.03))
            low = int(close * random.uniform(0.97, 1.0))
            open_price = int(close * random.uniform(0.99, 1.01))
            volume = random.randint(500000, 2000000)

            chart_data.append({
                'date': date.strftime('%Y-%m-%d'),
                'open': open_price,
                'high': high,
                'low': low,
                'close': close,
                'volume': volume
            })

            base_price = close

        return chart_data

    def _get_supply_demand_data(self, ì¢…ëª©ì½”ë“œ: str, days: int) -> List[Dict]:
        """ìˆ˜ê¸‰ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ëª¨ì˜ ë°ì´í„°)"""

        import random

        # ì‹¤ì œë¡œëŠ” ì—¬ê¸°ì„œ ì‹¤ì œ ìˆ˜ê¸‰ ë°ì´í„°ë¥¼ ê°€ì ¸ì™€ì•¼ í•¨
        # í˜„ì¬ëŠ” ëª¨ì˜ ë°ì´í„° ìƒì„±
        supply_data = []

        for i in range(days):
            date = datetime.now() - timedelta(days=i)

            # ì™¸êµ­ì¸: ê°„í—ì  ëŒ€ëŸ‰ ë§¤ìˆ˜
            if random.random() < 0.3:  # 30% í™•ë¥ ë¡œ ë§¤ìˆ˜
                ì™¸êµ­ì¸_ë§¤ìˆ˜ = random.randint(1000000, 5000000)
                ì™¸êµ­ì¸_ë§¤ë„ = random.randint(100000, 1000000)
            else:
                ì™¸êµ­ì¸_ë§¤ìˆ˜ = random.randint(100000, 1000000)
                ì™¸êµ­ì¸_ë§¤ë„ = random.randint(1000000, 3000000)

            # ê¸°ê´€: ì§€ì†ì  ë§¤ìˆ˜
            ê¸°ê´€_ë§¤ìˆ˜ = random.randint(500000, 2000000)
            ê¸°ê´€_ë§¤ë„ = random.randint(300000, 1500000)

            # ê°œì¸: ë³€ë™ì„± í° ë§¤ë§¤
            ê°œì¸_ë§¤ìˆ˜ = random.randint(2000000, 8000000)
            ê°œì¸_ë§¤ë„ = random.randint(2000000, 8000000)

            supply_data.append({
                'date': date.strftime('%Y-%m-%d'),
                'ì™¸êµ­ì¸_ë§¤ìˆ˜': ì™¸êµ­ì¸_ë§¤ìˆ˜,
                'ì™¸êµ­ì¸_ë§¤ë„': ì™¸êµ­ì¸_ë§¤ë„,
                'ê¸°ê´€_ë§¤ìˆ˜': ê¸°ê´€_ë§¤ìˆ˜,
                'ê¸°ê´€_ë§¤ë„': ê¸°ê´€_ë§¤ë„,
                'ê°œì¸_ë§¤ìˆ˜': ê°œì¸_ë§¤ìˆ˜,
                'ê°œì¸_ë§¤ë„': ê°œì¸_ë§¤ë„,
                # ì„¸ë¶„í™”ëœ ê¸°ê´€ ë°ì´í„° (ëª¨ì˜)
                'ì—°ê¸°ê¸ˆ_ë§¤ìˆ˜': random.randint(100000, 800000),
                'ì—°ê¸°ê¸ˆ_ë§¤ë„': random.randint(50000, 400000),
                'ëŒ€í˜•ìš´ìš©ì‚¬_ë§¤ìˆ˜': random.randint(200000, 1000000),
                'ëŒ€í˜•ìš´ìš©ì‚¬_ë§¤ë„': random.randint(100000, 500000),
            })

        return supply_data

    def _analyze_foreign_pattern(self, ìˆ˜ê¸‰_ë°ì´í„°: List[Dict]) -> Dict:
        """ì™¸êµ­ì¸ íŒ¨í„´ ë¶„ì„: 5ì¼ ìƒìŠ¹ í›„ ì°¨ìµì‹¤í˜„ íŒ¨í„´"""

        ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤ = []
        í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„ = None

        for i, day in enumerate(ìˆ˜ê¸‰_ë°ì´í„°):
            ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜ = day['ì™¸êµ­ì¸_ë§¤ìˆ˜'] - day['ì™¸êµ­ì¸_ë§¤ë„']

            if ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜ > 0:  # ë§¤ìˆ˜ì¼
                if í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„ is None:
                    í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„ = {
                        "ì‹œì‘ì¼": day['date'],
                        "ì§€ì†ì¼ìˆ˜": 1,
                        "ëˆ„ì ë§¤ìˆ˜": ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜
                    }
                else:
                    í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„["ì§€ì†ì¼ìˆ˜"] += 1
                    í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„["ëˆ„ì ë§¤ìˆ˜"] += ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜

            elif ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜ < 0 and í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„:  # ë§¤ë„ ì „í™˜
                í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„["ì¢…ë£Œì¼"] = day['date']
                ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤.append(í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„)
                í˜„ì¬_ë§¤ìˆ˜_êµ¬ê°„ = None

        # ìµœê·¼ 30ì¼ ì™¸êµ­ì¸ ìƒíƒœ
        ìµœê·¼_30ì¼ = ìˆ˜ê¸‰_ë°ì´í„°[:30]
        ìµœê·¼_ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜ = sum([day['ì™¸êµ­ì¸_ë§¤ìˆ˜'] - day['ì™¸êµ­ì¸_ë§¤ë„'] for day in ìµœê·¼_30ì¼])
        ìµœê·¼_ì—°ì†_ë§¤ìˆ˜ì¼ = self._calculate_consecutive_buying_days(ìµœê·¼_30ì¼, 'ì™¸êµ­ì¸')

        # ì°¨ìµì‹¤í˜„ ìœ„í—˜ë„ í‰ê°€
        ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„ = "ë‚®ìŒ"
        if ìµœê·¼_ì—°ì†_ë§¤ìˆ˜ì¼ >= 5:
            ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„ = "ë†’ìŒ"
        elif ìµœê·¼_ì—°ì†_ë§¤ìˆ˜ì¼ >= 3:
            ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„ = "ë³´í†µ"

        return {
            "ì´_ë§¤ìˆ˜êµ¬ê°„": len(ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤),
            "í‰ê· _ë§¤ìˆ˜ì§€ì†ì¼": sum([êµ¬ê°„["ì§€ì†ì¼ìˆ˜"] for êµ¬ê°„ in ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤]) / len(ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤) if ì™¸êµ­ì¸_ë§¤ìˆ˜_êµ¬ê°„ë“¤ else 0,
            "ìµœê·¼_30ì¼_ìˆœë§¤ìˆ˜": ìµœê·¼_ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜,
            "í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼": ìµœê·¼_ì—°ì†_ë§¤ìˆ˜ì¼,
            "ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„": ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„,
            "ì™¸êµ­ì¸_ìƒíƒœ": "ë§¤ìˆ˜ì„¸" if ìµœê·¼_ì™¸êµ­ì¸_ìˆœë§¤ìˆ˜ > 0 else "ë§¤ë„ì„¸"
        }

    def _analyze_institution_pattern(self, ìˆ˜ê¸‰_ë°ì´í„°: List[Dict]) -> Dict:
        """ê¸°ê´€ íŒ¨í„´ ë¶„ì„: ê³ ê¸‰ê¸°ê´€ vs ì¼ë°˜ê¸°ê´€"""

        ê³ ê¸‰ê¸°ê´€_ë°ì´í„° = []
        ì¼ë°˜ê¸°ê´€_ë°ì´í„° = []

        for day in ìˆ˜ê¸‰_ë°ì´í„°:
            # ê³ ê¸‰ê¸°ê´€ = ì—°ê¸°ê¸ˆ + ëŒ€í˜•ìš´ìš©ì‚¬
            ê³ ê¸‰ê¸°ê´€_ìˆœë§¤ìˆ˜ = (
                    day.get('ì—°ê¸°ê¸ˆ_ë§¤ìˆ˜', 0) - day.get('ì—°ê¸°ê¸ˆ_ë§¤ë„', 0) +
                    day.get('ëŒ€í˜•ìš´ìš©ì‚¬_ë§¤ìˆ˜', 0) - day.get('ëŒ€í˜•ìš´ìš©ì‚¬_ë§¤ë„', 0)
            )

            # ì¼ë°˜ê¸°ê´€ = ì „ì²´ ê¸°ê´€ - ê³ ê¸‰ê¸°ê´€
            ì „ì²´_ê¸°ê´€_ìˆœë§¤ìˆ˜ = day['ê¸°ê´€_ë§¤ìˆ˜'] - day['ê¸°ê´€_ë§¤ë„']
            ì¼ë°˜ê¸°ê´€_ìˆœë§¤ìˆ˜ = ì „ì²´_ê¸°ê´€_ìˆœë§¤ìˆ˜ - ê³ ê¸‰ê¸°ê´€_ìˆœë§¤ìˆ˜

            ê³ ê¸‰ê¸°ê´€_ë°ì´í„°.append(ê³ ê¸‰ê¸°ê´€_ìˆœë§¤ìˆ˜)
            ì¼ë°˜ê¸°ê´€_ë°ì´í„°.append(ì¼ë°˜ê¸°ê´€_ìˆœë§¤ìˆ˜)

        return {
            "ê³ ê¸‰ê¸°ê´€": {
                "30ì¼_ìˆœë§¤ìˆ˜": sum(ê³ ê¸‰ê¸°ê´€_ë°ì´í„°[:30]),
                "ë§¤ìˆ˜_ì§€ì†ì„±": self._calculate_consistency(ê³ ê¸‰ê¸°ê´€_ë°ì´í„°[:30]),
                "í™œë™_ê°•ë„": "ë†’ìŒ" if sum(ê³ ê¸‰ê¸°ê´€_ë°ì´í„°[:30]) > 0 else "ë‚®ìŒ"
            },
            "ì¼ë°˜ê¸°ê´€": {
                "30ì¼_ìˆœë§¤ìˆ˜": sum(ì¼ë°˜ê¸°ê´€_ë°ì´í„°[:30]),
                "ë³€ë™ì„±": self._calculate_volatility(ì¼ë°˜ê¸°ê´€_ë°ì´í„°[:30]),
                "ì‹ ë¢°ë„": "ë‚®ìŒ" if self._calculate_volatility(ì¼ë°˜ê¸°ê´€_ë°ì´í„°[:30]) > 0.5 else "ë³´í†µ"
            }
        }

    def _analyze_retail_pattern(self, ìˆ˜ê¸‰_ë°ì´í„°: List[Dict]) -> Dict:
        """ê°œì¸ ì—­ì§€í‘œ ë¶„ì„"""

        ê°œì¸_ë°ì´í„° = [(day['ê°œì¸_ë§¤ìˆ˜'] - day['ê°œì¸_ë§¤ë„']) for day in ìˆ˜ê¸‰_ë°ì´í„°]

        # ê°œì¸ ëŒ€ëŸ‰ ë§¤ìˆ˜ êµ¬ê°„ íƒì§€
        ëŒ€ëŸ‰_ë§¤ìˆ˜_êµ¬ê°„ = 0
        for i in range(len(ê°œì¸_ë°ì´í„°) - 5):
            êµ¬ê°„_5ì¼ = ê°œì¸_ë°ì´í„°[i:i + 5]
            if all(day > 0 for day in êµ¬ê°„_5ì¼):  # 5ì¼ ì—°ì† ìˆœë§¤ìˆ˜
                ëŒ€ëŸ‰_ë§¤ìˆ˜_êµ¬ê°„ += 1

        ìµœê·¼_ê°œì¸_ìˆœë§¤ìˆ˜ = sum(ê°œì¸_ë°ì´í„°[:30])

        return {
            "ìµœê·¼_30ì¼_ìˆœë§¤ìˆ˜": ìµœê·¼_ê°œì¸_ìˆœë§¤ìˆ˜,
            "ëŒ€ëŸ‰_ë§¤ìˆ˜_êµ¬ê°„": ëŒ€ëŸ‰_ë§¤ìˆ˜_êµ¬ê°„,
            "ì—­ì§€í‘œ_ì‹ í˜¸": "ìœ„í—˜" if ìµœê·¼_ê°œì¸_ìˆœë§¤ìˆ˜ > 0 else "ì–‘í˜¸",
            "ê°œì¸_ìƒíƒœ": "ë§¤ìˆ˜ì„¸" if ìµœê·¼_ê°œì¸_ìˆœë§¤ìˆ˜ > 0 else "ë§¤ë„ì„¸",
            "ì‹œì‚¬ì ": "ì¡°ì ˆ ìœ„í—˜" if ìµœê·¼_ê°œì¸_ìˆœë§¤ìˆ˜ > 0 else "ê±´ì „í•œ ìˆ˜ê¸‰"
        }

    def _assess_supply_risk(self, ì™¸êµ­ì¸_ë¶„ì„: Dict, ê¸°ê´€_ë¶„ì„: Dict, ê°œì¸_ë¶„ì„: Dict) -> Dict:
        """ìˆ˜ê¸‰ ìœ„í—˜ë„ ì¢…í•© í‰ê°€"""

        ìœ„í—˜_ìš”ì†Œë“¤ = []

        # ì™¸êµ­ì¸ ì°¨ìµì‹¤í˜„ ìœ„í—˜
        if ì™¸êµ­ì¸_ë¶„ì„["ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„"] == "ë†’ìŒ":
            ìœ„í—˜_ìš”ì†Œë“¤.append("ì™¸êµ­ì¸_ì°¨ìµì‹¤í˜„_ìœ„í—˜")

        # ê°œì¸ ì—­ë§¤ìˆ˜ ìœ„í—˜
        if ê°œì¸_ë¶„ì„["ì—­ì§€í‘œ_ì‹ í˜¸"] == "ìœ„í—˜":
            ìœ„í—˜_ìš”ì†Œë“¤.append("ê°œì¸_ì—­ë§¤ìˆ˜_ìœ„í—˜")

        # ê¸°ê´€ ì‹ ë¢°ë„ ìœ„í—˜
        if ê¸°ê´€_ë¶„ì„["ì¼ë°˜ê¸°ê´€"]["ì‹ ë¢°ë„"] == "ë‚®ìŒ":
            ìœ„í—˜_ìš”ì†Œë“¤.append("ê¸°ê´€_ë³€ë™ì„±_ìœ„í—˜")

        # ìœ„í—˜ë„ ë“±ê¸‰
        if len(ìœ„í—˜_ìš”ì†Œë“¤) >= 2:
            ìœ„í—˜ë„ = "ë†’ìŒ"
            ì ìˆ˜_ê°ì  = -15
        elif len(ìœ„í—˜_ìš”ì†Œë“¤) == 1:
            ìœ„í—˜ë„ = "ë³´í†µ"
            ì ìˆ˜_ê°ì  = -8
        else:
            ìœ„í—˜ë„ = "ë‚®ìŒ"
            ì ìˆ˜_ê°ì  = 0

        return {
            "ìœ„í—˜ë„": ìœ„í—˜ë„,
            "ìœ„í—˜_ìš”ì†Œë“¤": ìœ„í—˜_ìš”ì†Œë“¤,
            "ì ìˆ˜_ê°ì ": ì ìˆ˜_ê°ì 
        }

    def _calculate_supply_score(self, ì™¸êµ­ì¸_ë¶„ì„: Dict, ê¸°ê´€_ë¶„ì„: Dict, ê°œì¸_ë¶„ì„: Dict, ìœ„í—˜ë„_í‰ê°€: Dict) -> int:
        """ìˆ˜ê¸‰ ì ìˆ˜ ê³„ì‚°"""

        ì ìˆ˜ = 0

        # ì™¸êµ­ì¸ ì ìˆ˜ (ìµœëŒ€ 35ì )
        if ì™¸êµ­ì¸_ë¶„ì„["ì™¸êµ­ì¸_ìƒíƒœ"] == "ë§¤ìˆ˜ì„¸":
            ì ìˆ˜ += 20

            ì—°ì†ì¼ = ì™¸êµ­ì¸_ë¶„ì„["í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼"]
            if 1 <= ì—°ì†ì¼ <= 3:
                ì ìˆ˜ += 15  # ìµœì  êµ¬ê°„
            elif 4 <= ì—°ì†ì¼ <= 5:
                ì ìˆ˜ += 10  # ì£¼ì˜ êµ¬ê°„
            elif ì—°ì†ì¼ > 5:
                ì ìˆ˜ += 5  # ìœ„í—˜ êµ¬ê°„

        # ê³ ê¸‰ê¸°ê´€ ì ìˆ˜ (ìµœëŒ€ 20ì )
        if ê¸°ê´€_ë¶„ì„["ê³ ê¸‰ê¸°ê´€"]["30ì¼_ìˆœë§¤ìˆ˜"] > 0:
            ì ìˆ˜ += 10
            if ê¸°ê´€_ë¶„ì„["ê³ ê¸‰ê¸°ê´€"]["ë§¤ìˆ˜_ì§€ì†ì„±"] > 0.6:
                ì ìˆ˜ += 10

        # ê°œì¸ ì—­ì§€í‘œ ì ìˆ˜ (ìµœëŒ€ 10ì )
        if ê°œì¸_ë¶„ì„["ê°œì¸_ìƒíƒœ"] == "ë§¤ë„ì„¸":
            ì ìˆ˜ += 10
        elif ê°œì¸_ë¶„ì„["ê°œì¸_ìƒíƒœ"] == "ë§¤ìˆ˜ì„¸":
            ì ìˆ˜ -= 5

        # ìœ„í—˜ë„ ì°¨ê°
        ì ìˆ˜ += ìœ„í—˜ë„_í‰ê°€["ì ìˆ˜_ê°ì "]

        return max(0, min(50, ì ìˆ˜))  # 0~50ì  ë²”ìœ„

    def _calculate_moving_averages(self, ì¼ë´‰_ë°ì´í„°: List[Dict]) -> Dict:
        """ì´ë™í‰ê· ì„  ê³„ì‚°"""

        if len(ì¼ë´‰_ë°ì´í„°) < 60:
            return {"ì •ë°°ì—´": False, "ì´ë™í‰ê· ì„ ": {}}

        close_prices = [day['close'] for day in ì¼ë´‰_ë°ì´í„°]

        ma5 = sum(close_prices[:5]) / 5
        ma20 = sum(close_prices[:20]) / 20
        ma60 = sum(close_prices[:60]) / 60

        í˜„ì¬ê°€ = close_prices[0]
        ì •ë°°ì—´ = ma5 > ma20 > ma60 and í˜„ì¬ê°€ > ma5

        return {
            "ì •ë°°ì—´": ì •ë°°ì—´,
            "ì´ë™í‰ê· ì„ ": {
                "5ì¼ì„ ": ma5,
                "20ì¼ì„ ": ma20,
                "60ì¼ì„ ": ma60
            },
            "í˜„ì¬ê°€_vs_ì´í‰": {
                "vs_5ì¼ì„ ": (í˜„ì¬ê°€ / ma5 - 1) * 100,
                "vs_20ì¼ì„ ": (í˜„ì¬ê°€ / ma20 - 1) * 100,
                "vs_60ì¼ì„ ": (í˜„ì¬ê°€ / ma60 - 1) * 100
            }
        }

    def _analyze_chart_pattern(self, ì¼ë´‰_ë°ì´í„°: List[Dict]) -> Dict:
        """ì°¨íŠ¸ íŒ¨í„´ ë¶„ì„ (ê°„ë‹¨ ë²„ì „)"""

        if len(ì¼ë´‰_ë°ì´í„°) < 20:
            return {"íŒ¨í„´": "ë°ì´í„°ë¶€ì¡±", "ì‹ ë¢°ë„": 0}

        close_prices = [day['close'] for day in ì¼ë´‰_ë°ì´í„°[:20]]

        # ê°„ë‹¨í•œ ì¶”ì„¸ ë¶„ì„
        ìµœê·¼_5ì¼_í‰ê·  = sum(close_prices[:5]) / 5
        ê³¼ê±°_5ì¼_í‰ê·  = sum(close_prices[10:15]) / 5

        if ìµœê·¼_5ì¼_í‰ê·  > ê³¼ê±°_5ì¼_í‰ê·  * 1.05:
            íŒ¨í„´ = "ê°•í•œìƒìŠ¹"
            ì‹ ë¢°ë„ = 0.8
        elif ìµœê·¼_5ì¼_í‰ê·  > ê³¼ê±°_5ì¼_í‰ê· :
            íŒ¨í„´ = "ìƒìŠ¹"
            ì‹ ë¢°ë„ = 0.6
        elif ìµœê·¼_5ì¼_í‰ê·  < ê³¼ê±°_5ì¼_í‰ê·  * 0.95:
            íŒ¨í„´ = "í•˜ë½"
            ì‹ ë¢°ë„ = 0.3
        else:
            íŒ¨í„´ = "íš¡ë³´"
            ì‹ ë¢°ë„ = 0.4

        return {
            "íŒ¨í„´": íŒ¨í„´,
            "ì‹ ë¢°ë„": ì‹ ë¢°ë„
        }

    def _calculate_chart_bonus(self, ì°¨íŠ¸_ê²°ê³¼: Dict) -> int:
        """ì°¨íŠ¸ ë³´ë„ˆìŠ¤ ì ìˆ˜"""

        ì ìˆ˜ = 0

        # ì •ë°°ì—´ ë³´ë„ˆìŠ¤
        if ì°¨íŠ¸_ê²°ê³¼['ì´ë™í‰ê· _ë¶„ì„'].get('ì •ë°°ì—´', False):
            ì ìˆ˜ += 10

        # ì°¨íŠ¸ íŒ¨í„´ ë³´ë„ˆìŠ¤
        íŒ¨í„´ = ì°¨íŠ¸_ê²°ê³¼['ì°¨íŠ¸_íŒ¨í„´']['íŒ¨í„´']
        if íŒ¨í„´ == "ê°•í•œìƒìŠ¹":
            ì ìˆ˜ += 5
        elif íŒ¨í„´ == "ìƒìŠ¹":
            ì ìˆ˜ += 3

        return min(15, ì ìˆ˜)

    def _calculate_confidence(self, ì ìˆ˜_êµ¬ì„±: Dict, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> float:
        """ì‹ ë¢°ë„ ê³„ì‚°"""

        ì‹ ë¢°ë„ = 0.5  # ê¸°ë³¸ê°’

        # ì‹ ê³ ê°€ ì ìˆ˜ê°€ ë†’ìœ¼ë©´ ì‹ ë¢°ë„ ì¦ê°€
        if ì ìˆ˜_êµ¬ì„±['ì‹ ê³ ê°€_ì ìˆ˜'] >= 40:
            ì‹ ë¢°ë„ += 0.2

        # ìˆ˜ê¸‰ì´ ê±´ì „í•˜ë©´ ì‹ ë¢°ë„ ì¦ê°€
        if ìˆ˜ê¸‰_ê²°ê³¼['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜ë„'] == 'ë‚®ìŒ':
            ì‹ ë¢°ë„ += 0.2

        # ì™¸êµ­ì¸ ë§¤ìˆ˜ì„¸ë©´ ì‹ ë¢°ë„ ì¦ê°€
        if ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ'] == 'ë§¤ìˆ˜ì„¸':
            ì‹ ë¢°ë„ += 0.1

        return min(0.95, ì‹ ë¢°ë„)

    def _identify_key_strengths(self, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> List[str]:
        """í•µì‹¬ ê°•ì  ì‹ë³„"""

        ê°•ì ë“¤ = []

        # ì‹ ê³ ê°€ ê´€ë ¨
        ì‹ ê³ ê°€_ìƒíƒœ = ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ìƒíƒœ']
        if '60ì¼ì‹ ê³ ê°€' in ì‹ ê³ ê°€_ìƒíƒœ:
            ê°•ì ë“¤.append("âœ… 60ì¼ ì‹ ê³ ê°€ ë‹¬ì„± - ì¤‘ê¸° ëª¨ë©˜í…€ ê°•í•¨")
        if 'ì™„ì „ì‹ ê³ ê°€' in ì‹ ê³ ê°€_ìƒíƒœ:
            ê°•ì ë“¤.append("âœ… ì™„ì „ ì‹ ê³ ê°€ - ëª¨ë“  ê¸°ê°„ ìµœê³ ì ")

        # ì´ë™í‰ê·  ê´€ë ¨
        if ì°¨íŠ¸_ê²°ê³¼['ì´ë™í‰ê· _ë¶„ì„'].get('ì •ë°°ì—´', False):
            ê°•ì ë“¤.append("âœ… ì´ë™í‰ê·  ì •ë°°ì—´ - ê¸°ìˆ ì  ìƒìŠ¹ì„¸")

        # ìˆ˜ê¸‰ ê´€ë ¨
        if ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ'] == 'ë§¤ìˆ˜ì„¸':
            ì—°ì†ì¼ = ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼']
            if 1 <= ì—°ì†ì¼ <= 3:
                ê°•ì ë“¤.append("âœ… ì™¸êµ­ì¸ ê±´ì „í•œ ë§¤ìˆ˜ì„¸ - ì•ˆì •ì  ìˆ˜ê¸‰")
            elif ì—°ì†ì¼ > 3:
                ê°•ì ë“¤.append("âš ï¸ ì™¸êµ­ì¸ ì§€ì† ë§¤ìˆ˜ - ì°¨ìµì‹¤í˜„ ì£¼ì˜")

        if ìˆ˜ê¸‰_ê²°ê³¼['ê°œì¸_ë¶„ì„']['ê°œì¸_ìƒíƒœ'] == 'ë§¤ë„ì„¸':
            ê°•ì ë“¤.append("âœ… ê°œì¸ ë§¤ë„ì„¸ - ê±´ì „í•œ ì†ë°”ë€œ")

        if ìˆ˜ê¸‰_ê²°ê³¼['ê¸°ê´€_ë¶„ì„']['ê³ ê¸‰ê¸°ê´€']['í™œë™_ê°•ë„'] == 'ë†’ìŒ':
            ê°•ì ë“¤.append("âœ… ê³ ê¸‰ê¸°ê´€ ë§¤ìˆ˜ - í€ë”ë©˜í„¸ ì¸ì •")

        return ê°•ì ë“¤[:4]  # ìµœëŒ€ 4ê°œ

    def _identify_risks(self, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> List[str]:
        """ì£¼ì˜ì‚¬í•­ ì‹ë³„"""

        ìœ„í—˜ë“¤ = []

        # ìˆ˜ê¸‰ ìœ„í—˜
        ìœ„í—˜_ìš”ì†Œë“¤ = ìˆ˜ê¸‰_ê²°ê³¼['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜_ìš”ì†Œë“¤']
        for ìœ„í—˜ in ìœ„í—˜_ìš”ì†Œë“¤:
            if ìœ„í—˜ == "ì™¸êµ­ì¸_ì°¨ìµì‹¤í˜„_ìœ„í—˜":
                ìœ„í—˜ë“¤.append("âš ï¸ ì™¸êµ­ì¸ ì°¨ìµì‹¤í˜„ ì••ë ¥ ì¦ê°€")
            elif ìœ„í—˜ == "ê°œì¸_ì—­ë§¤ìˆ˜_ìœ„í—˜":
                ìœ„í—˜ë“¤.append("âš ï¸ ê°œì¸ ë§¤ìˆ˜ì„¸ - ì¡°ì ˆ ìœ„í—˜")
            elif ìœ„í—˜ == "ê¸°ê´€_ë³€ë™ì„±_ìœ„í—˜":
                ìœ„í—˜ë“¤.append("âš ï¸ ê¸°ê´€ ë§¤ë§¤ ë³€ë™ì„± ë†’ìŒ")

        # ì°¨íŠ¸ ìœ„í—˜
        íŒ¨í„´ = ì°¨íŠ¸_ê²°ê³¼['ì°¨íŠ¸_íŒ¨í„´']['íŒ¨í„´']
        if íŒ¨í„´ == "í•˜ë½":
            ìœ„í—˜ë“¤.append("âš ï¸ ì°¨íŠ¸ íŒ¨í„´ ì•½í™”")

        return ìœ„í—˜ë“¤[:3]  # ìµœëŒ€ 3ê°œ

    def _generate_smart_comment(self, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict, ì´ì : int, íˆ¬ìì˜ê²¬: str) -> str:
        """ìŠ¤ë§ˆíŠ¸ ì½”ë©˜íŠ¸ ìƒì„± (ìœ„í—˜ ìš°ì„  + ì‰¬ìš´ë§ + ì•¡ì…˜í˜•)"""

        # 1ë‹¨ê³„: ì£¼ìš” ìœ„í—˜ ì‹ë³„
        ì£¼ìš”_ìœ„í—˜ = self._identify_main_risk(ìˆ˜ê¸‰_ê²°ê³¼)

        # 2ë‹¨ê³„: í˜„ì¬ ìƒí™© ë¶„ì„
        í˜„ì¬_ìƒí™© = self._analyze_current_situation(ì°¨íŠ¸_ê²°ê³¼, ìˆ˜ê¸‰_ê²°ê³¼)

        # 3ë‹¨ê³„: íˆ¬ì ì•¡ì…˜ ê°€ì´ë“œ
        íˆ¬ì_ì•¡ì…˜ = self._get_investment_action(íˆ¬ìì˜ê²¬, ì£¼ìš”_ìœ„í—˜)

        # 4ë‹¨ê³„: ë©”ì‹œì§€ ì¡°í•© (50ì ë‚´ì™¸)
        if ì£¼ìš”_ìœ„í—˜:
            ì½”ë©˜íŠ¸ = f"âš ï¸ {ì£¼ìš”_ìœ„í—˜}. {íˆ¬ì_ì•¡ì…˜}"
        else:
            ì½”ë©˜íŠ¸ = f"âœ… {í˜„ì¬_ìƒí™©}. {íˆ¬ì_ì•¡ì…˜}"

        # ê¸¸ì´ ì œí•œ (50ì ë‚´ì™¸)
        if len(ì½”ë©˜íŠ¸) > 55:
            ì½”ë©˜íŠ¸ = ì½”ë©˜íŠ¸[:52] + "..."

        return ì½”ë©˜íŠ¸

    def _identify_main_risk(self, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> Optional[str]:
        """ì£¼ìš” ìœ„í—˜ ìš”ì†Œ ì‹ë³„"""

        ìœ„í—˜_ìš”ì†Œë“¤ = ìˆ˜ê¸‰_ê²°ê³¼['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜_ìš”ì†Œë“¤']

        if "ì™¸êµ­ì¸_ì°¨ìµì‹¤í˜„_ìœ„í—˜" in ìœ„í—˜_ìš”ì†Œë“¤:
            ì—°ì†ì¼ = ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼']
            return f"ì™¸êµ­ì¸ {ì—°ì†ì¼}ì¼ ì—°ì† ë§¤ìˆ˜ë¡œ ì°¨ìµì‹¤í˜„ ì£¼ì˜"
        elif "ê°œì¸_ì—­ë§¤ìˆ˜_ìœ„í—˜" in ìœ„í—˜_ìš”ì†Œë“¤:
            return "ê°œì¸ ë§¤ìˆ˜ì„¸ë¡œ ê³ ì  ì‹ í˜¸"
        elif "ê¸°ê´€_ë³€ë™ì„±_ìœ„í—˜" in ìœ„í—˜_ìš”ì†Œë“¤:
            return "ê¸°ê´€ ë§¤ë§¤ ë³€ë™ì„± ì¦ê°€"
        else:
            return None

    def _analyze_current_situation(self, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict) -> str:
        """í˜„ì¬ ìƒí™© ë¶„ì„"""

        ì‹ ê³ ê°€_ìƒíƒœ = ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ìƒíƒœ']
        ì™¸êµ­ì¸_ìƒíƒœ = ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ']

        # ì‹ ê³ ê°€ + ìˆ˜ê¸‰ ì¡°í•© ë©”ì‹œì§€
        if 'ì™„ì „ì‹ ê³ ê°€' in ì‹ ê³ ê°€_ìƒíƒœ:
            if ì™¸êµ­ì¸_ìƒíƒœ == 'ë§¤ìˆ˜ì„¸':
                return "ì™„ì „ ì‹ ê³ ê°€ + ìŠ¤ë§ˆíŠ¸ë¨¸ë‹ˆ ìœ ì…ìœ¼ë¡œ í­ë°œì  ìƒìŠ¹ì„¸"
            else:
                return "ì™„ì „ ì‹ ê³ ê°€ ë‹¬ì„±ìœ¼ë¡œ ê¸°ìˆ ì  ëŒíŒŒ í™•ì¸"
        elif '60ì¼ì‹ ê³ ê°€' in ì‹ ê³ ê°€_ìƒíƒœ:
            if ì™¸êµ­ì¸_ìƒíƒœ == 'ë§¤ìˆ˜ì„¸':
                return "60ì¼ ì‹ ê³ ê°€ ëŒíŒŒ + ì™¸êµ­ì¸ ë§¤ìˆ˜ë¡œ ì¤‘ê¸° ìƒìŠ¹ì„¸"
            else:
                return "60ì¼ ì‹ ê³ ê°€ ëŒíŒŒë¡œ ì¤‘ê¸° ëª¨ë©˜í…€ ì „í™˜"
        elif '20ì¼ì‹ ê³ ê°€' in ì‹ ê³ ê°€_ìƒíƒœ:
            if ì™¸êµ­ì¸_ìƒíƒœ == 'ë§¤ìˆ˜ì„¸':
                return "20ì¼ ì‹ ê³ ê°€ + ì™¸êµ­ì¸ ë§¤ìˆ˜ë¡œ ë‹¨ê¸° ìƒìŠ¹ì„¸"
            else:
                return "20ì¼ ì‹ ê³ ê°€ë¡œ ë‹¨ê¸° ìƒìŠ¹ ëª¨ë©˜í…€"
        else:
            if ì™¸êµ­ì¸_ìƒíƒœ == 'ë§¤ìˆ˜ì„¸':
                return "ì™¸êµ­ì¸ ë§¤ìˆ˜ë¡œ ìƒìŠ¹ ëª¨ë©˜í…€ í˜•ì„±"
            else:
                return "í˜„ì¬ ì‹ ê³ ê°€ ê¶Œì—­ ì ‘ê·¼ ì¤‘"

    def _get_investment_action(self, íˆ¬ìì˜ê²¬: str, ì£¼ìš”_ìœ„í—˜: Optional[str]) -> str:
        """íˆ¬ì ì•¡ì…˜ ê°€ì´ë“œ"""

        if ì£¼ìš”_ìœ„í—˜:  # ìœ„í—˜ì´ ìˆì„ ë•Œ
            if íˆ¬ìì˜ê²¬ == 'ê°•ë ¥ë§¤ìˆ˜':
                return "ì†Œí­ ì¡°ì • í›„ ë¶„í•  ë§¤ìˆ˜ ê¶Œì¥"
            elif íˆ¬ìì˜ê²¬ == 'ë§¤ìˆ˜':
                return "ìˆ˜ê¸‰ ì•ˆì •í™”ê¹Œì§€ ê´€ë§ í›„ ì§„ì…"
            else:
                return "ì¶”ê°€ ì‹ í˜¸ í™•ì¸ í›„ ì¬ê²€í† "
        else:  # ìœ„í—˜ì´ ì—†ì„ ë•Œ
            if íˆ¬ìì˜ê²¬ == 'ê°•ë ¥ë§¤ìˆ˜':
                return "ì ê·¹ ë§¤ìˆ˜ ê²€í†  ì‹œì "
            elif íˆ¬ìì˜ê²¬ == 'ë§¤ìˆ˜':
                return "ë§¤ìˆ˜ ì§„ì… íƒ€ì´ë°"
            elif íˆ¬ìì˜ê²¬ == 'ê´€ì‹¬':
                return "ê´€ì‹¬ ì¢…ëª© ë“±ë¡ ì¶”ì²œ"
            else:
                return "í˜„ ì‹œì  ì§„ì… ë¶€ë‹´"

    def _get_default_supply_analysis(self) -> Dict:
        """ìˆ˜ê¸‰ ë°ì´í„°ê°€ ì—†ì„ ë•Œ ê¸°ë³¸ê°’"""

        return {
            "ì™¸êµ­ì¸_ë¶„ì„": {
                "ì™¸êµ­ì¸_ìƒíƒœ": "ë°ì´í„°ì—†ìŒ",
                "í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼": 0,
                "ì°¨ìµì‹¤í˜„_ìœ„í—˜ë„": "ì•Œìˆ˜ì—†ìŒ"
            },
            "ê¸°ê´€_ë¶„ì„": {
                "ê³ ê¸‰ê¸°ê´€": {"í™œë™_ê°•ë„": "ì•Œìˆ˜ì—†ìŒ"},
                "ì¼ë°˜ê¸°ê´€": {"ì‹ ë¢°ë„": "ì•Œìˆ˜ì—†ìŒ"}
            },
            "ê°œì¸_ë¶„ì„": {
                "ê°œì¸_ìƒíƒœ": "ë°ì´í„°ì—†ìŒ",
                "ì—­ì§€í‘œ_ì‹ í˜¸": "ì•Œìˆ˜ì—†ìŒ"
            },
            "ìœ„í—˜ë„_í‰ê°€": {
                "ìœ„í—˜ë„": "ë³´í†µ",
                "ìœ„í—˜_ìš”ì†Œë“¤": [],
                "ì ìˆ˜_ê°ì ": 0
            },
            "ìˆ˜ê¸‰_ì ìˆ˜": 25,  # ì¤‘ê°„ ì ìˆ˜
            "í•µì‹¬_ì‹œì‚¬ì ": ["ğŸ“Š ìˆ˜ê¸‰ ë°ì´í„° ìˆ˜ì§‘ í•„ìš”"]
        }

    def _calculate_consecutive_buying_days(self, ë°ì´í„°: List[Dict], ì£¼ì²´: str) -> int:
        """ì—°ì† ë§¤ìˆ˜ì¼ ê³„ì‚°"""

        ì—°ì†ì¼ = 0

        for day in ë°ì´í„°:
            if ì£¼ì²´ == 'ì™¸êµ­ì¸':
                ìˆœë§¤ìˆ˜ = day['ì™¸êµ­ì¸_ë§¤ìˆ˜'] - day['ì™¸êµ­ì¸_ë§¤ë„']
            elif ì£¼ì²´ == 'ê¸°ê´€':
                ìˆœë§¤ìˆ˜ = day['ê¸°ê´€_ë§¤ìˆ˜'] - day['ê¸°ê´€_ë§¤ë„']
            elif ì£¼ì²´ == 'ê°œì¸':
                ìˆœë§¤ìˆ˜ = day['ê°œì¸_ë§¤ìˆ˜'] - day['ê°œì¸_ë§¤ë„']
            else:
                ìˆœë§¤ìˆ˜ = 0

            if ìˆœë§¤ìˆ˜ > 0:
                ì—°ì†ì¼ += 1
            else:
                break

        return ì—°ì†ì¼

    def _calculate_consistency(self, ë°ì´í„°_ë¦¬ìŠ¤íŠ¸: List[float]) -> float:
        """ì§€ì†ì„± ê³„ì‚° (ì–‘ìˆ˜ ë¹„ìœ¨)"""

        if not ë°ì´í„°_ë¦¬ìŠ¤íŠ¸:
            return 0

        ì–‘ìˆ˜_ê°œìˆ˜ = len([x for x in ë°ì´í„°_ë¦¬ìŠ¤íŠ¸ if x > 0])
        return ì–‘ìˆ˜_ê°œìˆ˜ / len(ë°ì´í„°_ë¦¬ìŠ¤íŠ¸)

    def _calculate_volatility(self, ë°ì´í„°_ë¦¬ìŠ¤íŠ¸: List[float]) -> float:
        """ë³€ë™ì„± ê³„ì‚° (í‘œì¤€í¸ì°¨/í‰ê· )"""

        if not ë°ì´í„°_ë¦¬ìŠ¤íŠ¸ or len(ë°ì´í„°_ë¦¬ìŠ¤íŠ¸) < 2:
            return 0

        í‰ê·  = sum(ë°ì´í„°_ë¦¬ìŠ¤íŠ¸) / len(ë°ì´í„°_ë¦¬ìŠ¤íŠ¸)
        if í‰ê·  == 0:
            return 1

        ë¶„ì‚° = sum([(x - í‰ê· ) ** 2 for x in ë°ì´í„°_ë¦¬ìŠ¤íŠ¸]) / len(ë°ì´í„°_ë¦¬ìŠ¤íŠ¸)
        í‘œì¤€í¸ì°¨ = ë¶„ì‚° ** 0.5

        return abs(í‘œì¤€í¸ì°¨ / í‰ê· )

    def _get_supply_insights(self, ì™¸êµ­ì¸_ë¶„ì„: Dict, ê¸°ê´€_ë¶„ì„: Dict, ê°œì¸_ë¶„ì„: Dict) -> List[str]:
        """ìˆ˜ê¸‰ í•µì‹¬ ì‹œì‚¬ì """

        ì‹œì‚¬ì ë“¤ = []

        # ì™¸êµ­ì¸ ê´€ë ¨
        if ì™¸êµ­ì¸_ë¶„ì„["ì™¸êµ­ì¸_ìƒíƒœ"] == "ë§¤ìˆ˜ì„¸":
            ì—°ì†ì¼ = ì™¸êµ­ì¸_ë¶„ì„["í˜„ì¬_ì—°ì†_ë§¤ìˆ˜ì¼"]
            if ì—°ì†ì¼ >= 5:
                ì‹œì‚¬ì ë“¤.append(f"ì™¸êµ­ì¸ {ì—°ì†ì¼}ì¼ ì—°ì† ë§¤ìˆ˜ - ì°¨ìµì‹¤í˜„ ì••ë ¥ ì¦ê°€")
            else:
                ì‹œì‚¬ì ë“¤.append(f"ì™¸êµ­ì¸ ë§¤ìˆ˜ì„¸ - ê±´ì „í•œ ìˆ˜ê¸‰ íë¦„")

        # ê°œì¸ ê´€ë ¨
        if ê°œì¸_ë¶„ì„["ê°œì¸_ìƒíƒœ"] == "ë§¤ë„ì„¸":
            ì‹œì‚¬ì ë“¤.append("ê°œì¸ ë§¤ë„ì„¸ - ê±´ì „í•œ ì†ë°”ë€œ ì§„í–‰")
        elif ê°œì¸_ë¶„ì„["ê°œì¸_ìƒíƒœ"] == "ë§¤ìˆ˜ì„¸":
            ì‹œì‚¬ì ë“¤.append("ê°œì¸ ë§¤ìˆ˜ì„¸ - ê³ ì  ê·¼ì²˜ ì‹ í˜¸ ì£¼ì˜")

        return ì‹œì‚¬ì ë“¤[:3]

    def _print_single_analysis_result(self, ì¢…ëª©ëª…: str, ì°¨íŠ¸_ê²°ê³¼: Dict, ìˆ˜ê¸‰_ê²°ê³¼: Dict, ì¢…í•©_ê²°ê³¼: Dict):
        """ê°œë³„ ì¢…ëª© ë¶„ì„ ê²°ê³¼ ì¶œë ¥"""

        print(f"ğŸ“Š {ì¢…ëª©ëª…} ë¶„ì„ ê²°ê³¼:")

        # ì‹ ê³ ê°€ ì •ë³´
        ì‹ ê³ ê°€_ìƒíƒœ = ', '.join(ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ìƒíƒœ']) if ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ìƒíƒœ'] else 'ì‹ ê³ ê°€ ì—†ìŒ'
        print(f"   ğŸ¯ ì‹ ê³ ê°€ ìƒíƒœ: {ì‹ ê³ ê°€_ìƒíƒœ} ({ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ì ìˆ˜']}ì )")

        # í˜„ì¬ê°€ ì •ë³´
        í˜„ì¬ê°€ = ì°¨íŠ¸_ê²°ê³¼['ì‹ ê³ ê°€_ì„¸ë¶€']['í˜„ì¬ê°€']
        print(f"   ğŸ’° í˜„ì¬ê°€: {í˜„ì¬ê°€:,}ì›")

        # ìˆ˜ê¸‰ ì •ë³´
        ì™¸êµ­ì¸_ìƒíƒœ = ìˆ˜ê¸‰_ê²°ê³¼['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ']
        ê°œì¸_ìƒíƒœ = ìˆ˜ê¸‰_ê²°ê³¼['ê°œì¸_ë¶„ì„']['ê°œì¸_ìƒíƒœ']
        print(f"   ğŸ’° ìˆ˜ê¸‰: ì™¸êµ­ì¸ {ì™¸êµ­ì¸_ìƒíƒœ}, ê°œì¸ {ê°œì¸_ìƒíƒœ} ({ìˆ˜ê¸‰_ê²°ê³¼['ìˆ˜ê¸‰_ì ìˆ˜']}ì )")

        # ìœ„í—˜ë„
        ìœ„í—˜ë„ = ìˆ˜ê¸‰_ê²°ê³¼['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜ë„']
        print(f"   âš ï¸ ìœ„í—˜ë„: {ìœ„í—˜ë„}")

        # ì¢…í•© ê²°ê³¼
        ìµœì¢…ì ìˆ˜ = ì¢…í•©_ê²°ê³¼['ìµœì¢…ì ìˆ˜']
        íˆ¬ìì˜ê²¬ = ì¢…í•©_ê²°ê³¼['íˆ¬ìì˜ê²¬']
        ì‹ ë¢°ë„ = ì¢…í•©_ê²°ê³¼['ì‹ ë¢°ë„']
        ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸ = ì¢…í•©_ê²°ê³¼['ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸']
        print(f"   ğŸ¯ ì¢…í•©: {ìµœì¢…ì ìˆ˜}ì  | {íˆ¬ìì˜ê²¬} | ì‹ ë¢°ë„ {ì‹ ë¢°ë„:.1%}")
        print(f"   ğŸ’¬ {ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸}")

        # í•µì‹¬ ê°•ì  (ìµœëŒ€ 2ê°œ)
        ê°•ì ë“¤ = ì¢…í•©_ê²°ê³¼['í•µì‹¬_ê°•ì '][:2]
        if ê°•ì ë“¤:
            print(f"   âœ… ê°•ì : {' / '.join(ê°•ì ë“¤)}")

        # ì£¼ì˜ì‚¬í•­ (ìµœëŒ€ 1ê°œ)
        ìœ„í—˜ë“¤ = ì¢…í•©_ê²°ê³¼['ì£¼ì˜ì‚¬í•­'][:1]
        if ìœ„í—˜ë“¤:
            print(f"   âš ï¸ ì£¼ì˜: {ìœ„í—˜ë“¤[0]}")

    def _print_final_summary(self, ë¶„ì„_ê²°ê³¼ë“¤: List[Dict]):
        """ìµœì¢… ë¶„ì„ ê²°ê³¼ ìš”ì•½"""

        if not ë¶„ì„_ê²°ê³¼ë“¤:
            return

        # íˆ¬ìì˜ê²¬ë³„ ë¶„ë¥˜
        ì˜ê²¬ë³„_í†µê³„ = {}
        for result in ë¶„ì„_ê²°ê³¼ë“¤:
            ì˜ê²¬ = result['ì¢…í•©í‰ê°€']['íˆ¬ìì˜ê²¬']
            ì˜ê²¬ë³„_í†µê³„[ì˜ê²¬] = ì˜ê²¬ë³„_í†µê³„.get(ì˜ê²¬, 0) + 1

        print(f"ğŸ“ˆ ì´ ë¶„ì„ ì¢…ëª©: {len(ë¶„ì„_ê²°ê³¼ë“¤)}ê°œ")
        print(f"ğŸ’° íˆ¬ìì˜ê²¬ë³„ ë¶„í¬:")
        for ì˜ê²¬, ê°œìˆ˜ in sorted(ì˜ê²¬ë³„_í†µê³„.items(), key=lambda x: x[1], reverse=True):
            print(f"   {ì˜ê²¬}: {ê°œìˆ˜}ê°œ")

        # ê³ ë“ì  ì¢…ëª© (80ì  ì´ìƒ)
        ê³ ë“ì _ì¢…ëª©ë“¤ = [r for r in ë¶„ì„_ê²°ê³¼ë“¤ if r['ì¢…í•©í‰ê°€']['ìµœì¢…ì ìˆ˜'] >= 80]
        if ê³ ë“ì _ì¢…ëª©ë“¤:
            print(f"\nâ­ ê³ ë“ì  ì¢…ëª© (80ì  ì´ìƒ): {len(ê³ ë“ì _ì¢…ëª©ë“¤)}ê°œ")
            for result in sorted(ê³ ë“ì _ì¢…ëª©ë“¤, key=lambda x: x['ì¢…í•©í‰ê°€']['ìµœì¢…ì ìˆ˜'], reverse=True)[:3]:
                ì¢…ëª©ëª… = result['ì¢…ëª©ì •ë³´']['ì¢…ëª©ëª…']
                ì ìˆ˜ = result['ì¢…í•©í‰ê°€']['ìµœì¢…ì ìˆ˜']
                ì˜ê²¬ = result['ì¢…í•©í‰ê°€']['íˆ¬ìì˜ê²¬']
                print(f"   ğŸ† {ì¢…ëª©ëª…}: {ì ìˆ˜}ì  ({ì˜ê²¬})")

        # ê°•ë ¥ë§¤ìˆ˜ ì¶”ì²œ
        ê°•ë ¥ë§¤ìˆ˜_ì¢…ëª©ë“¤ = [r for r in ë¶„ì„_ê²°ê³¼ë“¤ if r['ì¢…í•©í‰ê°€']['íˆ¬ìì˜ê²¬'] == 'ê°•ë ¥ë§¤ìˆ˜']
        if ê°•ë ¥ë§¤ìˆ˜_ì¢…ëª©ë“¤:
            print(f"\nğŸš€ ê°•ë ¥ë§¤ìˆ˜ ì¶”ì²œ: {len(ê°•ë ¥ë§¤ìˆ˜_ì¢…ëª©ë“¤)}ê°œ")
            for result in ê°•ë ¥ë§¤ìˆ˜_ì¢…ëª©ë“¤:
                ì¢…ëª©ëª… = result['ì¢…ëª©ì •ë³´']['ì¢…ëª©ëª…']
                ì‹ ê³ ê°€ìƒíƒœ = ', '.join(result['ì°¨íŠ¸ë¶„ì„']['ì‹ ê³ ê°€_ìƒíƒœ'][:2])
                ìˆ˜ê¸‰ìƒíƒœ = result['ìˆ˜ê¸‰ë¶„ì„']['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ']
                print(f"   ğŸ¯ {ì¢…ëª©ëª…}: {ì‹ ê³ ê°€ìƒíƒœ} / ì™¸êµ­ì¸ {ìˆ˜ê¸‰ìƒíƒœ}")

        # í‰ê·  ì ìˆ˜
        í‰ê· _ì ìˆ˜ = sum([r['ì¢…í•©í‰ê°€']['ìµœì¢…ì ìˆ˜'] for r in ë¶„ì„_ê²°ê³¼ë“¤]) / len(ë¶„ì„_ê²°ê³¼ë“¤)
        í‰ê· _ì‹ ë¢°ë„ = sum([r['ì¢…í•©í‰ê°€']['ì‹ ë¢°ë„'] for r in ë¶„ì„_ê²°ê³¼ë“¤]) / len(ë¶„ì„_ê²°ê³¼ë“¤)

        print(f"\nğŸ“Š í‰ê·  ì§€í‘œ:")
        print(f"   í‰ê·  ì ìˆ˜: {í‰ê· _ì ìˆ˜:.1f}ì ")
        print(f"   í‰ê·  ì‹ ë¢°ë„: {í‰ê· _ì‹ ë¢°ë„:.1%}")

        # ìˆ˜ê¸‰ ìƒíƒœ ìš”ì•½
        ì™¸êµ­ì¸_ë§¤ìˆ˜_ì¢…ëª© = len([r for r in ë¶„ì„_ê²°ê³¼ë“¤ if r['ìˆ˜ê¸‰ë¶„ì„']['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ'] == 'ë§¤ìˆ˜ì„¸'])
        ê°œì¸_ë§¤ë„_ì¢…ëª© = len([r for r in ë¶„ì„_ê²°ê³¼ë“¤ if r['ìˆ˜ê¸‰ë¶„ì„']['ê°œì¸_ë¶„ì„']['ê°œì¸_ìƒíƒœ'] == 'ë§¤ë„ì„¸'])

        print(f"\nğŸ’° ìˆ˜ê¸‰ í˜„í™©:")
        print(f"   ì™¸êµ­ì¸ ë§¤ìˆ˜ì„¸: {ì™¸êµ­ì¸_ë§¤ìˆ˜_ì¢…ëª©}ê°œ ({ì™¸êµ­ì¸_ë§¤ìˆ˜_ì¢…ëª© / len(ë¶„ì„_ê²°ê³¼ë“¤) * 100:.1f}%)")
        print(f"   ê°œì¸ ë§¤ë„ì„¸: {ê°œì¸_ë§¤ë„_ì¢…ëª©}ê°œ ({ê°œì¸_ë§¤ë„_ì¢…ëª© / len(ë¶„ì„_ê²°ê³¼ë“¤) * 100:.1f}%)")

    def _save_analysis_results(self, analysis_date: str, ë¶„ì„_ê²°ê³¼ë“¤: List[Dict]):
        """ë¶„ì„ ê²°ê³¼ DB ì €ì¥"""

        try:
            # ì°¨íŠ¸+ìˆ˜ê¸‰ ë¶„ì„ í…Œì´ë¸” ìƒì„±
            table_name = f"chart_supply_analysis_{analysis_date.replace('-', '')}"

            connection = self.db.get_connection(self.db.crawling_db)
            cursor = connection.cursor()

            # ê¸°ì¡´ í…Œì´ë¸” ì‚­ì œ í›„ ì¬ìƒì„±
            cursor.execute(f"DROP TABLE IF EXISTS {table_name}")

            create_sql = f"""
            CREATE TABLE {table_name} (
                id INT AUTO_INCREMENT PRIMARY KEY,
                stock_code VARCHAR(10) NOT NULL,
                stock_name VARCHAR(100) NOT NULL,
                current_price INT DEFAULT 0,
                new_high_score INT DEFAULT 0,
                new_high_status JSON,
                supply_score INT DEFAULT 0,
                foreign_status VARCHAR(20),
                retail_status VARCHAR(20),
                risk_level VARCHAR(20),
                final_score INT DEFAULT 0,
                investment_opinion VARCHAR(20),
                confidence_level DECIMAL(3,2),
                smart_comment TEXT,
                key_strengths JSON,
                risk_factors JSON,
                created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
                INDEX idx_final_score (final_score DESC),
                INDEX idx_investment_opinion (investment_opinion)
            ) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4
            """

            cursor.execute(create_sql)

            # ë°ì´í„° ì‚½ì…
            insert_sql = f"""
            INSERT INTO {table_name} 
            (stock_code, stock_name, current_price, new_high_score, new_high_status,
             supply_score, foreign_status, retail_status, risk_level,
             final_score, investment_opinion, confidence_level, smart_comment,
             key_strengths, risk_factors)
            VALUES (%s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s, %s)
            """

            saved_count = 0
            for result in ë¶„ì„_ê²°ê³¼ë“¤:
                try:
                    cursor.execute(insert_sql, (
                        result['ì¢…ëª©ì •ë³´']['ì¢…ëª©ì½”ë“œ'],
                        result['ì¢…ëª©ì •ë³´']['ì¢…ëª©ëª…'],
                        result['ì°¨íŠ¸ë¶„ì„']['ì‹ ê³ ê°€_ì„¸ë¶€']['í˜„ì¬ê°€'],
                        result['ì°¨íŠ¸ë¶„ì„']['ì‹ ê³ ê°€_ì ìˆ˜'],
                        json.dumps(result['ì°¨íŠ¸ë¶„ì„']['ì‹ ê³ ê°€_ìƒíƒœ'], ensure_ascii=False),
                        result['ìˆ˜ê¸‰ë¶„ì„']['ìˆ˜ê¸‰_ì ìˆ˜'],
                        result['ìˆ˜ê¸‰ë¶„ì„']['ì™¸êµ­ì¸_ë¶„ì„']['ì™¸êµ­ì¸_ìƒíƒœ'],
                        result['ìˆ˜ê¸‰ë¶„ì„']['ê°œì¸_ë¶„ì„']['ê°œì¸_ìƒíƒœ'],
                        result['ìˆ˜ê¸‰ë¶„ì„']['ìœ„í—˜ë„_í‰ê°€']['ìœ„í—˜ë„'],
                        result['ì¢…í•©í‰ê°€']['ìµœì¢…ì ìˆ˜'],
                        result['ì¢…í•©í‰ê°€']['íˆ¬ìì˜ê²¬'],
                        result['ì¢…í•©í‰ê°€']['ì‹ ë¢°ë„'],
                        result['ì¢…í•©í‰ê°€']['ìŠ¤ë§ˆíŠ¸_ì½”ë©˜íŠ¸'],
                        json.dumps(result['ì¢…í•©í‰ê°€']['í•µì‹¬_ê°•ì '], ensure_ascii=False),
                        json.dumps(result['ì¢…í•©í‰ê°€']['ì£¼ì˜ì‚¬í•­'], ensure_ascii=False)
                    ))
                    saved_count += 1
                except Exception as e:
                    print(f"   âŒ {result['ì¢…ëª©ì •ë³´']['ì¢…ëª©ëª…']} ì €ì¥ ì‹¤íŒ¨: {e}")

            cursor.close()
            connection.close()

            print(f"âœ… DB ì €ì¥ ì™„ë£Œ: {saved_count}/{len(ë¶„ì„_ê²°ê³¼ë“¤)}ê°œ ì¢…ëª©")
            print(f"ğŸ“Š í…Œì´ë¸”ëª…: {table_name}")
            print(f"ğŸ” ì €ì¥ëœ ë°ì´í„° í™•ì¸:")
            print(f"   SELECT stock_name, final_score, investment_opinion, smart_comment")
            print(f"   FROM {table_name} ORDER BY final_score DESC;")

        except Exception as e:
            print(f"âŒ DB ì €ì¥ ì‹¤íŒ¨: {e}")


def main():
    """ë©”ì¸ ì‹¤í–‰ í•¨ìˆ˜"""

    print("ğŸš€ ì‹¤ì „ ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„ í…ŒìŠ¤íŠ¸")
    print("=" * 80)
    print("ğŸ“‹ ë¶„ì„ í”„ë¡œì„¸ìŠ¤:")
    print("   1ï¸âƒ£ 52ì£¼ ì‹ ê³ ê°€ ì¢…ëª© í•„í„°ë§")
    print("   2ï¸âƒ£ ì‹ ê³ ê°€ ì ìˆ˜ (5ì¼/20ì¼/60ì¼)")
    print("   3ï¸âƒ£ ì‹¤ì „ ìˆ˜ê¸‰ ë¶„ì„ (ì™¸êµ­ì¸ 5ì¼ íŒ¨í„´)")
    print("   4ï¸âƒ£ ê°œì¸ ì—­ì§€í‘œ ë¶„ì„")
    print("   5ï¸âƒ£ ì¢…í•© ì ìˆ˜ ì‚°ì¶œ")
    print("=" * 80)

    analyzer = ChartSupplyAnalyzer()

    try:
        # ë¶„ì„ ë‚ ì§œ ì…ë ¥
        analysis_date = input("ë¶„ì„ ë‚ ì§œë¥¼ ì…ë ¥í•˜ì„¸ìš” (YYYY-MM-DD, ê¸°ë³¸ê°’: 2025-08-12): ").strip()
        if not analysis_date:
            analysis_date = '2025-08-12'

        # ë¶„ì„ ì‹¤í–‰
        success = analyzer.run_comprehensive_analysis(analysis_date)

        if success:
            print(f"\n{'=' * 80}")
            print("âœ… ì°¨íŠ¸+ìˆ˜ê¸‰ ì¢…í•© ë¶„ì„ ì™„ë£Œ!")
            print("ğŸ’¡ ì €ì¥ëœ ë¶„ì„ ê²°ê³¼ë¥¼ í™•ì¸í•˜ë ¤ë©´:")
            print(
                f"   SELECT * FROM crawling_db.chart_supply_analysis_{analysis_date.replace('-', '')} ORDER BY final_score DESC;")
            print(f"{'=' * 80}")
        else:
            print(f"\n{'=' * 80}")
            print("âŒ ë¶„ì„ ì‹¤íŒ¨ ë˜ëŠ” ì¡°ê±´ ë¯¸ì¶©ì¡±")
            print(f"{'=' * 80}")

    except KeyboardInterrupt:
        print(f"\n{'=' * 80}")
        print("â¹ï¸ ì‚¬ìš©ìì— ì˜í•´ ì¤‘ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤.")
        print(f"{'=' * 80}")
    except Exception as e:
        print(f"\n{'=' * 80}")
        print(f"âŒ ì˜ˆìƒì¹˜ ëª»í•œ ì˜¤ë¥˜: {e}")
        import traceback
        traceback.print_exc()
        print(f"{'=' * 80}")


if __name__ == "__main__":
    main()